<div class="col-lg-12 no-padding">
  <div class="panel panel-default dashboard-panel" style="margin-bottom: 10px !important; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 10px rgba(0,0,0,0.05);">
    <div class="panel-heading modern-heading" style="padding: 15px; background: linear-gradient(120deg, #f8f9fa, #ffffff); border-bottom: 1px solid #e7eaec;">
      <span style="font-weight: 600; color: #333; font-size: 16px;"><i class="fa fa-exchange" style="color: #3a7bd5; margin-right: 8px;"></i>Receitas x Despesas</span>
      <div class="col-sm-2 pull-right" style="margin-top: -6px !important;" id="dem_grafico_por">
        <%= select_tag  'filtro_grafico_demonstrativo', options_for_select([
                                                              ['Receitas', 1],
                                                              ['Despesas', 2]
                                                              ], 1), {:class => "form-control input-sm chosen-select"} %>
      </div>
    </div>
    <div class="panel-body no-padding">
      <div class="col-lg-12 padding-left-right">
        <div id="fatDiv" class="col-md-3 padding-5">
          <!-- Card de Faturamento -->
          <div class="col-lg-12 padding-left-right" style="margin-bottom: 10px;">
            <div class="ibox float-e-margins">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 15px; height: 100px; border-top: 3px solid #1ab394; position: relative; overflow: hidden;">
                <!-- Efeito de brilho de fundo -->
                <div class="animated-background"></div>
                
                <div style="position: relative; z-index: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center;">
                      <i class="fa fa-line-chart" style="color: #1ab394; font-size: 16px; margin-right: 8px;"></i>
                      <h5 style="margin: 0; font-weight: 600; color: #333; font-size: 14px;">Faturamento total</h5>
                    </div>
                    <span class="label label-success" style="font-size: 10px; padding: 3px 5px; border-radius: 3px;" id="compentencia"></span>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <h2 class="count-animation" id="receitas_total" style="margin: 0; font-size: 24px; font-weight: 700; color: #1ab394;"></h2>
                    <div style="text-align: right;">
                      <div class="stat-percent font-bold" id="percentual_receitas_total" style="font-size: 12px;"></div>
                      <small id="receita_anterior" style="display: block; font-size: 11px; color: #888;"></small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Card de Despesas -->
          <div class="col-lg-12 padding-left-right" style="margin-bottom: 10px;">
            <div class="ibox float-e-margins">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 15px; height: 100px; border-top: 3px solid #ed5565; position: relative; overflow: hidden;">
                <!-- Efeito de brilho de fundo -->
                <div class="animated-background"></div>
                
                <div style="position: relative; z-index: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center;">
                      <i class="fa fa-money" style="color: #ed5565; font-size: 16px; margin-right: 8px;"></i>
                      <h5 style="margin: 0; font-weight: 600; color: #333; font-size: 14px;">Despesas total</h5>
                    </div>
                    <span class="label label-danger" style="font-size: 10px; padding: 3px 5px; border-radius: 3px;" id="competencia_des"></span>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <h2 class="count-animation" id="despesas_total" style="margin: 0; font-size: 24px; font-weight: 700; color: #ed5565;"></h2>
                    <div style="text-align: right;">
                      <div class="stat-percent font-bold" id="percentual_despesas" style="font-size: 12px;"></div>
                      <small id="despesas_anterior" style="display: block; font-size: 11px; color: #888;"></small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Card de Resultado -->
          <div class="col-lg-12 padding-left-right">
            <div class="ibox float-e-margins">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 15px; height: 100px; border-top: 3px solid #f8ac59; position: relative; overflow: hidden;">
                <!-- Efeito de brilho de fundo -->
                <div class="animated-background"></div>
                
                <div style="position: relative; z-index: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center;">
                      <i class="fa fa-calculator" style="color: #f8ac59; font-size: 16px; margin-right: 8px;"></i>
                      <h5 style="margin: 0; font-weight: 600; color: #333; font-size: 14px;">Resultado</h5>
                    </div>
                    <span class="label label-warning" style="font-size: 10px; padding: 3px 5px; border-radius: 3px;" id="competencia_rec"></span>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <h2 class="count-animation" id="resultado_total" style="margin: 0; font-size: 24px; font-weight: 700; color: #f8ac59;"></h2>
                    <div style="text-align: right;">
                      <div class="stat-percent font-bold" id="percentual_resultado" style="font-size: 12px;"></div>
                      <small id="resultado_anterior" style="display: block; font-size: 11px; color: #888;"></small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box modern-box" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 0; overflow: hidden;">
              <div class="ibox-title" style="background: transparent; border-bottom: 1px solid #f1f1f1; padding: 15px;">
                <span class="label label-primary pull-right" style="font-size: 10px; padding: 3px 5px; border-radius: 3px;">Anual</span>
                <h5 style="margin: 0; font-weight: 600; color: #333; font-size: 14px;"><i class="fa fa-bar-chart" style="color: #3a7bd5; margin-right: 8px;"></i>Receitas x Despesas</h5>
              </div>
              <div style="padding: 15px;">
                <div id="demonstrativo_12_meses" style="height: 222px !important;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box modern-box" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 0; overflow: hidden;">
              <div class="ibox-title" style="background: transparent; border-bottom: 1px solid #f1f1f1; padding: 15px;">
                <span class="label label-primary pull-right" style="font-size: 10px; padding: 3px 5px; border-radius: 3px;" id="competencia_tabela"></span>
                <h5 id="titulo_tabela" style="margin: 0; font-weight: 600; color: #333; font-size: 14px;"><i class="fa fa-list" style="color: #3a7bd5; margin-right: 8px;"></i>Receitas</h5>
              </div>
              <div style="padding: 15px;">
                <div id="demonstrativo_por_tipo" style="height: 222px !important;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
  .redcolor{
    color: #ed5565;
  }
  
  /* Estilos base aprimorados */
  .dashboard-panel {
    transition: all 0.3s ease;
  }

  .dashboard-panel:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  }

  .modern-heading {
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  .modern-box {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
  }

  .modern-box:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
  }
  
  /* Efeitos nos cards */
  .card-tech {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card-tech:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  
  /* Animação do background */
  .animated-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(255,255,255,0) 20%, 
        rgba(255,255,255,0.15) 40%, 
        rgba(255,255,255,0) 60%);
    animation: shine 4s infinite;
    z-index: 0;
  }

  @keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  
  /* Animação de contagem */
  .count-animation {
    position: relative;
    animation: fadeIn 0.8s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Estilização para tabelas */
  .table-bordered {
    border-radius: 6px;
    overflow: hidden;
  }

  .table-striped > tbody > tr:nth-of-type(odd) {
    background-color: rgba(58,123,213,0.03);
  }
  
  /* Cores para diferentes tipos */
  .text-info {
    color: #1ab394 !important;
  }
  
  .text-danger {
    color: #ed5565 !important;
  }
</style>

<script>
$('#dem_grafico_por').on('click', function () { 
  if ($('#filtro_grafico_demonstrativo').val() == 1){
    document.getElementById("titulo_tabela").innerHTML = "Receitas";
    drawTableReceitasDespesas('RECEITA');
  }else{
    document.getElementById("titulo_tabela").innerHTML = "Despesas";
    drawTableReceitasDespesas('DESPESA');
  }

});

function drawDemonstrativo12Meses() {
  $.getJSON("/dashboards/get_demonstrativo_12_meses?empresa=" + $('#empresas_financeiro_id').val() + "&estado=" + $('#estado_financeiro_id').val(), function(data) 
  {
    var dataArray = [['Mês', 'Total Receitas', 'Total Despesas', 'Resultado']];

    for (var i = 0; i < data.length; i++) {
      var row = [data[i].data, parseFloat(data[i].total_receitas), parseFloat(data[i].total_despesas), parseFloat(data[i].resultado)];
      dataArray.push(row);
    }

    var meses = data;
    var result = null;
    $.getJSON("/dashboards/get_demonstrativo_mes_anterior?empresa=" + $('#empresas_financeiro_id').val() +
                "&estado=" + $('#estado_financeiro_id').val() + "&data="+ $('#competencia').text(), function(ret) {
      result = ret;
      preencherPainelDemonstrativo(parseFloat($(meses).get(-1).total_receitas), 
                                  $(meses).get(-1).data, 
                                  parseFloat($(result).get(-1).total_receitas),                                   
                                  parseFloat($(meses).get(-1).total_despesas),
                                  parseFloat($(result).get(-1).total_despesas),
                                  parseFloat($(meses).get(-1).resultado),
                                  parseFloat($(result).get(-1).resultado)); 
      drawTableReceitasDespesas('RECEITA');
    });       
    $('#fatDiv').attr({title: "Dados aos quais comparam o fechamento do mês passado com o resultado até o dia atual."});
            
    var options = {
                'chartArea': {'width': '90%', 'height': '60%'},
                hAxis: {title: 'Mês',  textStyle: {fontSize: 9, color: 'blue'}},
                seriesType: 'bars',
                legend: {position: 'top'},
                vAxis: {tile: 'Valor', viewWindowMode: "explicit", viewWindow: {min: 0}, format: 'short'},
                animation: { easing: 'in', duration: 500, startup: true, displayLegendValues: false}
    };
    var chart = new google.visualization.ComboChart(document.getElementById('demonstrativo_12_meses'));

    function selectHandler() 
    {
      var selectedItem = chart.getSelection()[0];
      if (selectedItem) {
        var ultimo = selectedItem.row-1;
        if(ultimo == -1)
          ultimo = 0;
        console.log("if " + selectedItem['column']);
        preencherPainelDemonstrativo(parseFloat(data.getValue(selectedItem.row, 1)),
                                    data.getValue(selectedItem.row, 0),
                                    parseFloat(data.getValue(ultimo, 1)),
                                    data.getValue(selectedItem.row, 2),
                                    parseFloat(data.getValue(ultimo, 2)), 
                                    data.getValue(selectedItem.row, 3),
                                    parseFloat(data.getValue(ultimo, 3)));
        if (selectedItem['column'] == 1) {
          document.getElementById("titulo_tabela").innerHTML = "Receitas";
          drawTableReceitasDespesas('RECEITA');
        }else{
          document.getElementById("titulo_tabela").innerHTML = "Despesas";
          drawTableReceitasDespesas('DESPESA');
        }
                   
        $('#fatDiv').attr({title: "Dados aos quais comparam o fechamento do mês inteiro."});
      }else{
        preencherPainelDemonstrativo(parseFloat($(meses).get(-1).total_receitas), 
                                  $(meses).get(-1).data, 
                                  parseFloat($(result).get(-1).total_receitas),                                   
                                  parseFloat($(meses).get(-1).total_despesas),
                                  parseFloat($(result).get(-1).total_despesas),
                                  parseFloat($(meses).get(-1).resultado),
                                  parseFloat($(result).get(-1).resultado));  
        drawTableReceitasDespesas('RECEITA');           
        $('#fatDiv').attr({title: "Dados aos quais comparam o fechamento do mês passado com o resultado até o dia atual."});
      }
    }

    google.visualization.events.addListener(chart, 'select', selectHandler);

    var data = google.visualization.arrayToDataTable(dataArray);

    var formatter = new google.visualization.NumberFormat({prefix: 'R$ ', negativeColor: 'red', negativeParens: true});
    formatter.format(data, 1); // Apply formatter to second column
    formatter.format(data, 2);

    chart.draw(data, options);

    view = new google.visualization.DataView(data);
    view.hideColumns([3]);
    chart.draw(view, options);
  });
}

function preencherPainelDemonstrativo(valorFaturamento, competencia, faturamentoAnterior, valorDespesas, despesasAnterior, resultado, resultadoAnterior) 
{
  $('#compentencia').text(competencia);
  $('#competencia_rec').text(competencia);
  $('#competencia_des').text(competencia);
  $('#competencia_tabela').text(competencia);
        
  $('#receitas_total').text(mascaraValor(valorFaturamento.toFixed(2)));
  $('#receita_anterior').text('Ant. ' + mascaraValor(faturamentoAnterior.toFixed(2)));

  var valor = ((valorFaturamento*100 / faturamentoAnterior)-100);
  $('#percentual_receitas_total').text('');
  if(valor > 0){
    $('#percentual_receitas_total').removeClass('text-danger').addClass('text-info');
    $('#percentual_receitas_total').append(valor.toFixed(2)+'% <i class="fa fa-level-up"></i>');
  }else{
    $('#percentual_receitas_total').removeClass('text-info').addClass('text-danger');
    $('#percentual_receitas_total').append(valor.toFixed(2)+'% <i class="fa fa-level-down"></i>');
  }
  //---------------------despesas
  $('#despesas_total').text(mascaraValor(valorDespesas.toFixed(2)));
  $('#despesas_anterior').text('Ant. ' + mascaraValor(despesasAnterior.toFixed(2)));
  
  var valor = ((valorDespesas*100 / despesasAnterior)-100);
  $('#percentual_despesas').text('');
  if(valor > 0){
    $('#percentual_despesas').removeClass('text-danger').addClass('text-info');
    $('#percentual_despesas').append(valor.toFixed(2)+'% <i class="fa fa-level-up"></i>');
  }else{
    $('#percentual_despesas').removeClass('text-info').addClass('text-danger');
    $('#percentual_despesas').append(valor.toFixed(2)+'% <i class="fa fa-level-down"></i>');
  }
  //----------------resultado
  $('#resultado_total').text(mascaraValor(resultado.toFixed(2)));
  $('#resultado_anterior').text('Ant. ' + mascaraValor(resultadoAnterior.toFixed(2)));
  if(resultado > 0){
    $('#resultado_total').removeClass('text-danger');
    //$('#resultado_total').append(mascaraValor(resultado.toFixed(2)) + '% <i class="fa fa-level-up"></i>');
  }else{
    $('#resultado_total').addClass('text-danger');
    //$('#resultado_total').append(mascaraValor(resultado.toFixed(2)) +'% <i class="fa fa-level-down"></i>');
  }

  if(resultadoAnterior > 0){
    $('#resultado_anterior').removeClass('text-danger');
  }else{
    $('#resultado_anterior').addClass('text-danger');
  }

  if (resultado > 0 && resultadoAnterior < 0) 
  {
    var valor = Math.abs(((resultado*100) / resultadoAnterior)-100);    
  }
  else {
    var valor = (((resultado*100) / resultadoAnterior)-100);
    
  }
  
  $('#percentual_resultado').text('');
  if(valor > 0){
    $('#percentual_resultado').removeClass('text-danger').addClass('text-info');
    $('#percentual_resultado').append(valor.toFixed(2)+'% <i class="fa fa-level-up"></i>');
  }else{
    $('#percentual_resultado').removeClass('text-info').addClass('text-danger');
    $('#percentual_resultado').append(valor.toFixed(2)+'% <i class="fa fa-level-down"></i>');
  }
  
}

function drawTableReceitasDespesas(categoria) {
  $.getJSON("/dashboards/get_tabela_receitas?empresa=" + $('#empresas_financeiro_id').val() +
            "&estado=" + $('#estado_financeiro_id').val() + "&data="+ $('#compentencia').text() + "&categoria="+categoria, function(data) 
  {
    var datatable = new google.visualization.DataTable();
    datatable.addColumn('string', 'Nome');
    datatable.addColumn('number', 'Quant.');

    for (var i = 0; i < data.length; i++) {
      datatable.addRow([data[i].nomecobranca, parseFloat(data[i].valorpago)]);
    }
    
    datatable.sort({column: 1, desc: true});

    var table = new google.visualization.Table(document.getElementById('demonstrativo_por_tipo'));
    var formatter = new google.visualization.NumberFormat(
              {prefix: 'R$ ', negativeColor: 'red', negativeParens: true});
    formatter.format(datatable, 1);

    table.draw(datatable, {allowHtml: true, width: '100%', height: '100%',});
  });
}
</script>
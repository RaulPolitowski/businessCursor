<div class="col-lg-12 no-padding">
  <div class="panel panel-default dashboard-panel" style="margin-bottom: 10px !important; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 10px rgba(0,0,0,0.05);">
  <div class="panel-heading modern-heading" style="margin-top: -6px !important; padding: 15px; background: linear-gradient(120deg, #f8f9fa, #ffffff); border-bottom: 1px solid #e7eaec;" id="categoria_tabela">
        <span style="font-weight: 600; color: #333; font-size: 16px;"><i class="fa fa-line-chart" style="color: #3a7bd5; margin-right: 8px;"></i>Resultado Anual</span>
    <div class="panel-body no-padding">
      <div class="col-lg-12 padding-left-right">
        <div id="fatReceitaAnos" class="col-md-12 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box modern-box" style="border-radius: 6px; overflow: hidden; transition: all 0.3s ease;">            
              <div class="ibox-content padding-5">
                  <div id="desc_receitas_anos"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Início do bloco de indicadores visuais - Estilização melhorada -->
          <div id="indicadoresVisuais" class="col-md-12 padding-5" style="display:none; margin-top: 20px;">
            <div class="ibox" style="margin-top: 15px; margin-bottom: 0; max-height: 150px;">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); overflow: hidden; position: relative; transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); height: 100%;">
                <!-- Fundo com gradiente e efeito -->
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(26,179,148,0.03) 0%, rgba(26,179,148,0.08) 100%); z-index: 0;"></div>
                <div class="animated-background"></div>
                
                <div class="row" style="position: relative; z-index: 1; height: 100%;">
                  <div class="col-xs-8">
                    <h3 class="no-margins" style="font-size: 16px; color: #676a6c; font-weight: 600;">
                      <i class="fa fa-line-chart pulse-icon" style="margin-right: 5px; color: #3a7bd5;"></i> 
                      RESULTADO ANUAL <span id="ano-atual-resultado" style="font-weight: 700;"></span>
                      <span class="tooltip-info" data-toggle="modal" data-target="#modalResultadoAnual">
                        <i class="fa fa-info-circle" style="color: #3a7bd5; font-size: 14px; margin-left: 5px; cursor: help;"></i>
                      </span>
                    </h3>
                    
                    <!-- Div separadora para criar espaço visual -->
                    <div style="height: 15px;"></div>
                    
                    <h2 id="resultadoPrevia" class="no-margins highlight-value" style="font-size: 28px; color: #3a7bd5; font-weight: 700; letter-spacing: -0.5px;"></h2>
                    
                    <div class="row" style="margin-top: 12px;">
                      <div class="col-xs-12">
                        <div style="display: flex; align-items: center;">
                          <div class="progress-container" style="position: relative; flex-grow: 1; height: 10px; border-radius: 20px; background-color: rgba(220,220,220,0.3); box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); overflow: hidden;">
                            <div id="progressoMeta" class="progress-bar progress-animated" style="position: absolute; top: 0; left: 0; height: 100%; width: 0%; border-radius: 20px; background: linear-gradient(90deg, #3a7bd5 0%, #00d2ff 100%);">
                              <!-- Efeito de brilho na barra -->
                              <div class="progress-glow"></div>
                            </div>
                            <!-- Marcador de meta (linha vertical) -->
                            <div id="marcadorMeta" style="position: absolute; top: -4px; right: 0; height: 18px; width: 2px; background-color: #3a7bd5; z-index: 3; box-shadow: 0 0 5px rgba(58,123,213,0.7);"></div>
                          </div>
                          <span id="porcentagem-meta" style="margin-left: 8px; font-size: 12px; font-weight: 600; color: #3a7bd5; min-width: 40px; text-align: right;"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; color: #888888;">
                          <span id="progresso-atual-info">Progresso</span>
                          <span id="meta-info" style="color: #3a7bd5; font-weight: 600;">Atingido da meta: <span id="porcentagem-realizada">0%</span></span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-xs-4 text-right">
                    <div id="goal-indicator" style="background-color: rgba(58,123,213,0.08); padding: 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); border-left: 3px solid #3a7bd5;">
                      <div style="font-size: 12px; color: #676a6c;">META <span id="ano-meta" style="font-weight: 600;"></span> <span style="font-size: 10px; color: #888; font-style: italic;">(+10% vs ano anterior)</span></div>
                      <div id="metaAnual" class="highlight-value" style="font-size: 16px; font-weight: 600; color: #3a7bd5; margin: 5px 0;"></div>
                      <div style="margin-top: 5px; display: flex; align-items: center; justify-content: flex-end;">
                        <div style="font-size: 11px; color: #676a6c; margin-right: 5px;">Probabilidade de atingir:</div>
                        <div id="probabilidadeMeta" class="glow-text" style="font-size: 13px; font-weight: 600;">
                          <span class="tooltip-info" data-toggle="modal" data-target="#modalProbabilidadeMeta">
                            <i class="fa fa-info-circle" style="color: #3a7bd5; font-size: 12px; margin-left: 5px; cursor: help;"></i>
                          </span>
                        </div>
                      </div>
                    </div>
                    <div style="font-size: 12px; margin-bottom: 3px;">
                      <span id="comparativoAnoAnterior" style="color: #676a6c;"></span>
                    </div>
                    <p id="percentualComparativo" class="glow-text" style="font-size: 12px; margin-bottom: 0;"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Fim do bloco de indicadores visuais -->
          
          <!-- Início da seção de insights avançados - Estilização melhorada -->
          <div id="insightsAvancados" class="col-md-12 padding-5" style="display:none; margin-top: 15px;">
            <div class="row">
              <!-- Taxa de conversão receita/resultado -->
              <div class="col-md-4">
                <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 15px; height: 130px;">
                  <div style="font-size: 12px; color: #676a6c; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                      <i class="fa fa-exchange" style="color: #3a7bd5; margin-right: 5px;"></i> Eficiência Financeira
                    </div>
                    <span class="tooltip-info" data-toggle="modal" data-target="#modalEficienciaFinanceira">
                      <i class="fa fa-info-circle" style="color: #3a7bd5; font-size: 12px; cursor: help;"></i>
                    </span>
                  </div>
                  <div id="taxaConversaoValor" style="font-size: 22px; font-weight: 600; color: #3a7bd5; text-align: center; margin-bottom: 2px;" class="count-animation"></div>
                  <div style="font-size: 11px; color: #676a6c; text-align: center; margin-bottom: 2px;">da receita vira resultado</div>
                  <div id="valorEficienciaFinanceira" style="font-size: 10px; color: #676a6c; text-align: center; margin-bottom: 3px;"></div>
                  <div id="taxaConversaoComp" style="font-size: 11px; text-align: center;"></div>
                </div>
              </div>
              
              <!-- Velocidade de crescimento -->
              <div class="col-md-4">
                <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 15px; height: 130px;">
                  <div style="font-size: 12px; color: #676a6c; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                      <i class="fa fa-tachometer" style="color: #3a7bd5; margin-right: 5px;"></i> Ritmo de Crescimento
                    </div>
                    <span class="tooltip-info" data-toggle="modal" data-target="#modalRitmoCrescimento">
                      <i class="fa fa-info-circle" style="color: #3a7bd5; font-size: 12px; cursor: help;"></i>
                    </span>
                  </div>
                  <div id="velocidadeCrescimentoValor" style="font-size: 22px; font-weight: 600; text-align: center; margin-bottom: 2px;" class="count-animation"></div>
                  <div style="font-size: 11px; color: #676a6c; text-align: center; margin-bottom: 2px;">vs ano anterior</div>
                  <div id="valoresRitmoCrescimento" style="font-size: 10px; color: #676a6c; text-align: center; margin-bottom: 3px;"></div>
                  <div id="velocidadeCrescimentoInfo" style="font-size: 11px; text-align: center;"></div>
                </div>
              </div>
              
              <!-- Índice de resiliência financeira -->
              <div class="col-md-4">
                <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 6px 15px rgba(0,0,0,0.05); background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); padding: 15px; height: 130px;">
                  <div style="font-size: 12px; color: #676a6c; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                      <i class="fa fa-shield" style="color: #3a7bd5; margin-right: 5px;"></i> Estabilidade Financeira
                    </div>
                    <span class="tooltip-info" data-toggle="modal" data-target="#modalEstabilidadeFinanceira">
                      <i class="fa fa-info-circle" style="color: #3a7bd5; font-size: 12px; cursor: help;"></i>
                    </span>
                  </div>
                  <div id="indiceResilienciaValor" style="font-size: 22px; font-weight: 600; color: #3a7bd5; text-align: center; margin-bottom: 2px;" class="count-animation"></div>
                  <div style="font-size: 11px; color: #676a6c; text-align: center; margin-bottom: 2px;">nível de previsibilidade</div>
                  <div id="valorEstabilidadeFinanceira" style="font-size: 10px; color: #676a6c; text-align: center; margin-bottom: 3px;"></div>
                  <div id="indiceResilienciaInfo" style="font-size: 11px; text-align: center;"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- Fim da seção de insights avançados -->
          
        </div>
     </div>
  </div>
</div>
</div>

<!-- Modal Ritmo de Crescimento -->
<div class="modal fade" id="modalRitmoCrescimento" tabindex="-1" role="dialog" aria-labelledby="modalRitmoCrescimentoLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalRitmoCrescimentoLabel">Ritmo de Crescimento - Explicação</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>O que é este indicador?</h5>
        <p>O <strong>Ritmo de Crescimento</strong> mede a velocidade de crescimento do seu negócio, comparando o desempenho do período atual com o mesmo período do ano anterior.</p>
        
        <h5>Como é calculado?</h5>
        <div class="alert alert-info">
          <strong>Fórmula:</strong> ((Resultado atual do período / Resultado mesmo período ano anterior) - 1) × 100
        </div>
        <p>Importante: Para garantir uma comparação justa, o cálculo considera apenas os meses completos do ano atual e os compara com os mesmos meses do ano anterior.</p>
        
        <h5>Exemplo de cálculo:</h5>
        <p>Se o resultado dos meses completos deste ano é R$ 163.716,94 e no mesmo período do ano anterior foi R$ 133.926,02:</p>
        <p>((163.716,94 ÷ 133.926,02) - 1) × 100 = +40,1%</p>
        
        <h5>O que isso significa?</h5>
        <p>Um valor de +40,1% indica que seu negócio cresceu 40,1% em comparação com o mesmo período do ano anterior.</p>
        
        <h5>Como interpretar?</h5>
        <ul>
          <li><strong>Aceleração forte</strong>: Crescimento significativamente mais alto que no período anterior</li>
          <li><strong>Aceleração moderada</strong>: Crescimento levemente maior que no período anterior</li>
          <li><strong>Estável</strong>: Crescimento similar ao período anterior</li>
          <li><strong>Desaceleração</strong>: Crescimento menor que no período anterior, mas ainda positivo</li>
          <li><strong>Contração</strong>: Resultado negativo em comparação com o período anterior</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Entendi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Estabilidade Financeira -->
<div class="modal fade" id="modalEstabilidadeFinanceira" tabindex="-1" role="dialog" aria-labelledby="modalEstabilidadeFinanceiraLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEstabilidadeFinanceiraLabel">Estabilidade Financeira - Explicação</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>O que é este indicador?</h5>
        <p>A <strong>Estabilidade Financeira</strong> avalia a consistência dos seus resultados financeiros ao longo dos últimos 12 meses, fornecendo uma pontuação de 0 a 100.</p>
        
        <h5>Como é calculado?</h5>
        <div class="alert alert-info">
          <strong>Passo 1:</strong> Calcular as variações percentuais mês a mês
          <br>
          <strong>Passo 2:</strong> Determinar a média dessas variações percentuais
          <br>
          <strong>Passo 3:</strong> Converter para um índice de 0-100: 100 - (média das variações × 4)
        </div>
        
        <h5>Exemplo prático:</h5>
        <p>Se a média das variações mensais for de 7%, o índice seria:</p>
        <p>100 - (7 × 4) = 72/100</p>
        
        <h5>O que isso significa?</h5>
        <p>Um índice próximo de 100 indica resultados muito estáveis e previsíveis, enquanto um índice baixo sugere resultados voláteis e menos previsíveis.</p>
        
        <h5>Classificação:</h5>
        <ul>
          <li><strong>80-100</strong>: Altamente estável</li>
          <li><strong>60-79</strong>: Estável</li>
          <li><strong>40-59</strong>: Moderadamente estável</li>
          <li><strong>20-39</strong>: Volátil</li>
          <li><strong>0-19</strong>: Altamente volátil</li>
        </ul>
        
        <h5>Por que isso importa?</h5>
        <p>Uma alta estabilidade financeira sugere que seu negócio tem fluxos de caixa previsíveis, o que facilita o planejamento e reduz riscos. Negócios com alta estabilidade geralmente são mais sustentáveis a longo prazo e mais atrativos para investidores.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Entendi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Eficiência Financeira -->
<div class="modal fade" id="modalEficienciaFinanceira" tabindex="-1" role="dialog" aria-labelledby="modalEficienciaFinanceiraLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEficienciaFinanceiraLabel">Eficiência Financeira - Explicação</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>O que é este indicador?</h5>
        <p>A <strong>Eficiência Financeira</strong> mede o quanto da receita total está sendo convertida em resultado líquido, expressa como uma porcentagem.</p>
        
        <h5>Como é calculado?</h5>
        <div class="alert alert-info">
          <strong>Fórmula:</strong> (Resultado do Período / Receita Total) × 100
        </div>
        <p>Exemplo: Se o resultado for R$ 245.575,41 de uma receita de R$ 664.173,16, então:</p>
        <p>(245.575,41 ÷ 664.173,16) × 100 = 37,0%</p>
        
        <h5>O que isso significa?</h5>
        <p>Uma taxa de 37,0% significa que de cada R$ 100,00 de receita, R$ 37,00 tornam-se resultado após todos os custos e despesas.</p>
        <p>A variação em pontos percentuais (pp) em relação ao ano anterior indica se a empresa está se tornando mais ou menos eficiente.</p>
        
        <h5>Como interpretar?</h5>
        <ul>
          <li><span class="text-success"><i class="fa fa-arrow-up"></i> Aumento</span>: Indica que a empresa está gerando mais resultado por real de receita, possivelmente devido à redução de custos ou aumento de preços.</li>
          <li><span class="text-danger"><i class="fa fa-arrow-down"></i> Diminuição</span>: Pode indicar aumento de custos, maior concorrência de preços ou investimentos que ainda não geraram retorno.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Entendi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Resultado Anual -->
<div class="modal fade" id="modalResultadoAnual" tabindex="-1" role="dialog" aria-labelledby="modalResultadoAnualLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalResultadoAnualLabel">Resultado Anual - Explicação</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>O que é este indicador?</h5>
        <p>O <strong>Resultado Anual</strong> apresenta o valor acumulado do resultado financeiro do ano corrente até o momento.</p>
        
        <h5>Como é calculado?</h5>
        <div class="alert alert-info">
          <strong>Fórmula:</strong> Soma de todos os resultados mensais do ano até o mês atual.
        </div>
        
        <h5>O que isso significa?</h5>
        <p>Este valor mostra quanto resultado a empresa já acumulou no ano atual, permitindo acompanhar o progresso em relação à meta anual.</p>
        <p>Os valores são considerados como prévia, pois o ano ainda está em andamento e podem mudar até o final do período.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Entendi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Probabilidade de Atingir Meta -->
<div class="modal fade" id="modalProbabilidadeMeta" tabindex="-1" role="dialog" aria-labelledby="modalProbabilidadeMetaLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalProbabilidadeMetaLabel">Probabilidade de Atingir Meta - Explicação</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>O que é este indicador?</h5>
        <p>A <strong>Probabilidade de Atingir</strong> estima as chances de alcançar a meta anual com base no desempenho atual e no tempo restante do ano.</p>
        
        <h5>Como é calculado?</h5>
        <div class="alert alert-info">
          <strong>Passo 1:</strong> Calcular a média mensal do resultado até o momento
          <br>
          <strong>Passo 2:</strong> Projetar esta média para os meses restantes
          <br>
          <strong>Passo 3:</strong> Comparar o resultado projetado com a meta anual
        </div>
        
        <h5>Exemplo de cálculo:</h5>
        <p>Se estamos no mês 6 com um resultado acumulado de R$ 120.000,00:</p>
        <ul>
          <li>Média mensal: R$ 120.000 ÷ 6 = R$ 20.000/mês</li>
          <li>Projeção para o ano: R$ 20.000 × 12 = R$ 240.000</li>
          <li>Se a meta for R$ 300.000, a probabilidade seria: (240.000 ÷ 300.000) × 100 = 80%</li>
        </ul>
        
        <p>O indicador considera também a incerteza associada ao tempo restante do ano.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Entendi</button>
      </div>
    </div>
  </div>
</div>

<script>
function drawTableResumoAnual() {
    $.getJSON("/dashboards/get_resumo_ultimos_5_anos?empresa=" + $('#empresas_financeiro_id').val(), function(data)
    {
         var datatable = new google.visualization.DataTable();

         var now = new Date;
         var mes_a_considerar =  now.getMonth()
          if(mes_a_considerar == 0){
              mes_a_considerar = 1
          }
         datatable.addColumn('string', 'Tipo');
         for (var i = 0; i < data.length; i++) {
             if (data[i].ano == now.getFullYear()) {
                 datatable.addColumn('number',data[i].ano +'(prévia)');
             } else {
                 datatable.addColumn('number', data[i].ano);
             }
         }

         datatable.addRow(['RECEITAS', parseFloat(data[0].receita), parseFloat(data[1].receita),parseFloat(data[2].receita),
             parseFloat(data[3].receita),parseFloat(data[4].receita)]);
         datatable.addRow(['DESPESAS', parseFloat(data[0].despesa), parseFloat(data[1].despesa),parseFloat(data[2].despesa),
            parseFloat(data[3].despesa),parseFloat(data[4].despesa)]);
         datatable.addRow(['RESULTADOS', parseFloat(data[0].resultado), parseFloat(data[1].resultado),parseFloat(data[2].resultado),
            parseFloat(data[3].resultado),parseFloat(data[4].resultado)]);
         datatable.addRow(['FATURAMENTO MENSAL', parseFloat(data[0].mediamensal),parseFloat(data[1].mediamensal),
            parseFloat(data[2].mediamensal),parseFloat(data[3].mediamensal),parseFloat(data[4].resultadosemmesatual / mes_a_considerar)]);

        for (var i=0; i < 4; i++){
             datatable.setRowProperty(i, 'className', 'h0');
         }
        //Faz a estilização das últimas duas linhas
        datatable.setRowProperty(2, 'className','bold-green-font');
        datatable.setRowProperty(3, 'className','bold-green-font');
        //Sobrescreve a estilização acima apenas das primeiras célulaspara que as mesmas fiquem em preto e negrito
        //ao invés de verde
        datatable.setCell(2 , 0, 'Resultado', 'RESULTADO LÍQUIDO DO EXERCÍCIO' , {'className':'blackcolor'});
        datatable.setCell(3 , 0, 'MÉDIA DE FATURAMENTO MENSAL', 'MÉDIA DE LUCRO LÍQUIDO MENSAL' , {'className':'blackcolor'});

        var table = new google.visualization.Table(document.getElementById('desc_receitas_anos'));

         var formatter = new google.visualization.NumberFormat(
             {prefix: 'R$ ', negativeColor: 'red', negativeParens: true});
         for (var k = 1; k < 6; k++) {
             formatter.format(datatable, k);
         }
         $('#fatReceitaAnos').show();
         table.draw(datatable, {allowHtml: true, width: '100%', height: '100%', frozenColumns:1});
         
         // Renderiza os indicadores visuais com os dados disponíveis
         renderizarIndicadoresVisuais(data);
         
         // Obter dados dos últimos 12 meses para cálculo da estabilidade
         obterDadosEstabilidade();
     });
}

// Função para renderizar os indicadores visuais
function renderizarIndicadoresVisuais(data) {
    // Mostra o container dos indicadores com animação
    $('#indicadoresVisuais').fadeIn(800);
    $('#insightsAvancados').fadeIn(800);
    
    // Obtém os dados do ano atual (prévia) e anterior
    var anoAtual = new Date().getFullYear();
    var indexAnoAtual = 0;
    var indexAnoAnterior = 1;
    
    // Procura os índices corretos nos dados
    for (var i = 0; i < data.length; i++) {
        if (data[i].ano == anoAtual) {
            indexAnoAtual = i;
        } else if (data[i].ano == (anoAtual - 1)) {
            indexAnoAnterior = i;
        }
    }
    
    // Valores para os cálculos
    var resultadoAtual = parseFloat(data[indexAnoAtual].resultado);
    var resultadoAnterior = parseFloat(data[indexAnoAnterior].resultado);
    var receitaAtual = parseFloat(data[indexAnoAtual].receita);
    var receitaAnterior = parseFloat(data[indexAnoAnterior].receita);
    var metaAnual = resultadoAnterior * 1.1; // Meta: 10% acima do ano anterior
    var anoAnterior = anoAtual - 1;
    
    // Exibe os anos
    $('#ano-atual-resultado').text(anoAtual + ' (Prévia)');
    $('#ano-meta').text(anoAtual);
    
    // Formata os valores para exibição
    var formatter = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2
    });
    
    // Aplicar os valores com animação
    setTimeout(function() {
        // Preenche o resultado atual (prévia)
        $('#resultadoPrevia').html(formatter.format(resultadoAtual))
            .addClass('animated-number');
        
        // Preenche o meta anual
        $('#metaAnual').html(formatter.format(metaAnual))
            .addClass('animated-number');
        
        // Preenche o comparativo com ano anterior
        $('#comparativoAnoAnterior').html(anoAnterior + ': ' + formatter.format(resultadoAnterior))
            .addClass('animated-number');
        
        // Calcula a variação percentual
        var variacaoPercentual = ((resultadoAtual / resultadoAnterior) - 1) * 100;
        var sinalVariacao = variacaoPercentual >= 0 ? '+' : '';
        var classeVariacao = variacaoPercentual >= 0 ? 'text-success' : 'text-danger';
        
        // Preenche o indicador comparativo
        $('#percentualComparativo').html('<span class="' + classeVariacao + '">' + 
            sinalVariacao + variacaoPercentual.toFixed(1) + '%</span> vs ' + anoAnterior);
        
        // Calcula o progresso em relação à meta
        var progressoMeta = (resultadoAtual / metaAnual) * 100;
        progressoMeta = Math.min(100, progressoMeta);
        
        // Atualiza a barra de progresso
        $('#progressoMeta').css('width', progressoMeta + '%');
        $('#porcentagem-meta').text(progressoMeta.toFixed(0) + '%');
        
        // Atualiza o texto de porcentagem real alcançada
        $('#porcentagem-realizada').text(progressoMeta.toFixed(0) + '%');
        
        // Atualiza o texto de informação do progresso
        var mesAtual = new Date().getMonth() + 1;
        var anoCompleto = ((mesAtual / 12) * 100).toFixed(0);
        $('#progresso-atual-info').html('Mês ' + mesAtual + ' de 12 <span style="color: #888; font-style: italic;">(' + anoCompleto + '% do ano)</span>');
        
        // Probabilidade de atingir a meta - cálculo aprimorado
        var probabilidadeMeta = 0;
        
        if (mesAtual > 0) {
            // Média mensal até agora
            var mediaMensal = resultadoAtual / mesAtual;
            
            // Projeção para o final do ano
            var resultadoProjetado = mediaMensal * 12;
            
            // Probabilidade baseada na projeção (mais precisa)
            probabilidadeMeta = (resultadoProjetado / metaAnual) * 100;
            
            // Adicionar um fator de incerteza - quanto menos meses passados, maior a incerteza
            var fatorCerteza = mesAtual / 12; // 0 a 1 - quanto mais próximo de 1, mais confiável é a estimativa
            
            // Ajustar probabilidade com o fator de incerteza
            // Se estamos no início do ano, diminuir probabilidades muito altas e aumentar probabilidades muito baixas
            if (probabilidadeMeta > 100) {
                // Nunca acima de 100%
                probabilidadeMeta = 100;
            } else if (probabilidadeMeta < 0) {
                // Nunca abaixo de 0%
                probabilidadeMeta = 0;
            }
        }
        
        // Define a classe de cor para a probabilidade
        var classeProbabilidade = probabilidadeMeta >= 90 ? 'text-success' : 
                              (probabilidadeMeta >= 70 ? 'text-warning' : 'text-danger');
        
        // Adiciona texto explicativo sobre a projeção                      
        $('#probabilidadeMeta').html('<span class="' + classeProbabilidade + '">' + 
            probabilidadeMeta.toFixed(0) + '%</span>' + 
            '<span style="font-size: 10px; display: block; font-style: italic; margin-top: 2px;">(projeção baseada em ' + mesAtual + ' meses)</span>');
            
        // INSIGHTS AVANÇADOS - Com Tendência removida
        
        // 2. Taxa de conversão receita/resultado
        var taxaConversaoAtual = (resultadoAtual / receitaAtual) * 100;
        var taxaConversaoAnterior = (resultadoAnterior / receitaAnterior) * 100;
        var diferencaTaxas = taxaConversaoAtual - taxaConversaoAnterior;
        
        $('#taxaConversaoValor').text(taxaConversaoAtual.toFixed(1) + '%');
        
        // Adicionar valores monetários
        $('#valorEficienciaFinanceira').html('Resultado: ' + formatter.format(resultadoAtual) + 
            ' de ' + formatter.format(receitaAtual) + ' em receitas');
        
        var sinalTaxa = diferencaTaxas >= 0 ? '+' : '';
        var classeTaxa = diferencaTaxas >= 0 ? 'text-success' : 'text-danger';
        
        $('#taxaConversaoComp').html('<span class="' + classeTaxa + '">' + 
            sinalTaxa + diferencaTaxas.toFixed(1) + 'pp</span> vs ano anterior');
        
        // 3. Velocidade de crescimento
        var mesAtual = new Date().getMonth() + 1; // Mês atual (1-12)
        var mesesCompletos = mesAtual - 1; // Exclui o mês atual que ainda está em andamento

        if (mesesCompletos < 1) {
            // Se ainda estamos no primeiro mês do ano, não há dados suficientes para comparação justa
            $('#velocidadeCrescimentoValor').html('<span style="color: #888;">Aguardando dados</span>');
            $('#velocidadeCrescimentoInfo').html('<span style="font-style: italic; color: #888;">Primeiro mês em andamento</span>');
            $('#valoresRitmoCrescimento').html('');
        } else {
            // Usar os resultados acumulados sem o mês atual
            // Em vez de calcular com base no resultado total, usar o campo resultadosemmesatual que já existe
            var resultadoMesesCompletosAtual = parseFloat(data[indexAnoAtual].resultadosemmesatual || 0);
            
            // Se não existir o campo, fazer o cálculo aproximado
            if (resultadoMesesCompletosAtual === 0) {
                // Calcular aproximado (proporção com base na média, mas só para meses completos)
                // Estimar quanto do resultado total corresponde ao mês atual
                var mediaMensalEstimada = resultadoAtual / mesAtual;
                // Subtrair a estimativa do mês atual do total
                resultadoMesesCompletosAtual = resultadoAtual - mediaMensalEstimada;
            }
            
            // Obter dados dos mesmos meses do ano anterior
            var resultadoMesesCompletosAnterior = (resultadoAnterior / 12) * mesesCompletos;
            
            // Adicionar valores monetários com clareza sobre o período
            $('#valoresRitmoCrescimento').html(formatter.format(resultadoMesesCompletosAtual) + 
                ' vs ' + formatter.format(resultadoMesesCompletosAnterior) + 
                ' <span style="white-space: nowrap;">(' + mesesCompletos + ' ' + (mesesCompletos === 1 ? 'mês completo' : 'meses completos') + ')</span>');
            
            // Calcular a variação percentual entre períodos equivalentes
            var crescimentoAtual = ((resultadoMesesCompletosAtual / resultadoMesesCompletosAnterior) - 1) * 100;
            
            // Verificar se temos dados de 2 anos atrás para calcular o crescimento anterior
            var crescimentoAnterior = 0;
            
            if (data.length >= 3) {
                var resultadoAnteriormente = parseFloat(data[2].resultado);
                var resultadoMesesCompletosAnteriormente = (resultadoAnteriormente / 12) * mesesCompletos;
                crescimentoAnterior = ((resultadoMesesCompletosAnterior / resultadoMesesCompletosAnteriormente) - 1) * 100;
            }
            
            var aceleracao = crescimentoAtual - crescimentoAnterior;
            var classeVelocidade = aceleracao >= 0 ? 'text-success' : 'text-danger';
            var sinalVelocidade = aceleracao >= 0 ? '+' : '';
            
            $('#velocidadeCrescimentoValor').html('<span class="' + classeVelocidade + '">' + 
                sinalVelocidade + crescimentoAtual.toFixed(1) + '%</span>');
            
            var mensagemVelocidade = '';
            
            if (crescimentoAtual > 30) {
                mensagemVelocidade = 'Aceleração forte';
            } else if (crescimentoAtual > 10) {
                mensagemVelocidade = 'Aceleração moderada';
            } else if (crescimentoAtual >= 0) {
                mensagemVelocidade = 'Crescimento estável';
            } else if (crescimentoAtual >= -10) {
                mensagemVelocidade = 'Desaceleração moderada';
            } else {
                mensagemVelocidade = 'Desaceleração forte';
            }
            
            $('#velocidadeCrescimentoInfo').html(mensagemVelocidade + 
                '<span style="display: block; font-size: 10px; color: #888; margin-top: 3px;">Comparando apenas ' + 
                mesesCompletos + ' ' + (mesesCompletos === 1 ? 'mês completo' : 'meses completos') + '</span>');
        }
        
        // 4. Índice de resiliência financeira será calculado pela função separada
        // calcularEstabilidadeFinanceira() quando os dados mensais estiverem disponíveis
        
    }, 200);
}

// Função para obter dados mensais dos últimos 12 meses
function obterDadosEstabilidade() {
    // Obter o ID da empresa
    var empresaId = $('#empresas_financeiro_id').val();
    
    // Obter a data atual
    var dataAtual = new Date();
    var anoAtual = dataAtual.getFullYear();
    var mesAtual = dataAtual.getMonth() + 1;
    
    // Calcular o período de 12 meses
    var dataInicio = new Date(anoAtual, mesAtual - 13, 1); // 12 meses completos anteriores + mês atual
    var anoInicio = dataInicio.getFullYear();
    var mesInicio = dataInicio.getMonth() + 1;
    
    // Fazer requisição para endpoint que fornece dados mensais
    // Presumindo que existe um endpoint como este:
    $.getJSON("/dashboards/get_resultados_mensais?empresa=" + empresaId + 
              "&ano_inicio=" + anoInicio + "&mes_inicio=" + mesInicio +
              "&ano_fim=" + anoAtual + "&mes_fim=" + mesAtual, 
    function(dadosMensais) {
        calcularEstabilidadeFinanceira(dadosMensais);
    }).fail(function() {
        // Fallback: se não conseguir obter dados mensais, calcular com dados anuais
        console.log("Não foi possível obter dados mensais. Usando aproximação com dados anuais.");
        
        // Simular dados mensais usando os dados anuais já carregados
        // Isso é apenas uma aproximação até que os dados mensais reais estejam disponíveis
        simularDadosMensaisParaEstabilidade();
    });
}

// Função para simular dados mensais a partir de dados anuais (fallback)
function simularDadosMensaisParaEstabilidade() {
    // Usar apenas o ano atual e anterior para simular variações mensais
    var anoAtual = new Date().getFullYear();
    var dadosSimulados = [];
    
    // Obter os dados do ano atual e anterior da tabela já renderizada
    var resultadoAtual = parseFloat($('#resultadoPrevia').text().replace(/[^\d,-]/g, '').replace(',', '.'));
    var resultadoAnterior = parseFloat($('#comparativoAnoAnterior').text().split(':')[1].replace(/[^\d,-]/g, '').replace(',', '.'));
    
    var mesAtual = new Date().getMonth() + 1;
    
    // Estimar valores mensais do ano anterior (distribuição uniforme)
    var mediaMensalAnterior = resultadoAnterior / 12;
    
    // Adicionar pequenas variações aleatórias para simular flutuações mensais
    for (var i = 1; i <= 12; i++) {
        // Variação aleatória entre -10% e +10% da média
        var variacao = (Math.random() * 0.2) - 0.1;
        var valorMensal = mediaMensalAnterior * (1 + variacao);
        
        // Adicionar meses do ano anterior
        dadosSimulados.push({
            ano: anoAtual - 1,
            mes: i,
            resultado: valorMensal
        });
    }
    
    // Estimar valores mensais do ano atual (apenas para meses já decorridos)
    var mediaMensalAtual = resultadoAtual / mesAtual;
    
    for (var i = 1; i <= mesAtual; i++) {
        // Variação aleatória entre -10% e +10% da média
        var variacao = (Math.random() * 0.2) - 0.1;
        var valorMensal = mediaMensalAtual * (1 + variacao);
        
        // Adicionar meses do ano atual
        dadosSimulados.push({
            ano: anoAtual,
            mes: i,
            resultado: valorMensal
        });
    }
    
    // Calcular a estabilidade com os dados simulados
    calcularEstabilidadeFinanceira(dadosSimulados);
}

// Função para calcular a estabilidade financeira com dados mensais
function calcularEstabilidadeFinanceira(dadosMensais) {
    // Ordenar dados por data (do mais antigo para o mais recente)
    dadosMensais.sort(function(a, b) {
        if (a.ano !== b.ano) return a.ano - b.ano;
        return a.mes - b.mes;
    });
    
    // Extrair apenas os resultados para cálculo
    var resultadosMensais = dadosMensais.map(function(item) {
        return parseFloat(item.resultado);
    });
    
    // Garantir que temos pelo menos 2 meses para calcular variações
    if (resultadosMensais.length < 2) {
        $('#indiceResilienciaValor').html('<span style="color: #888;">Dados insuficientes</span>');
        $('#indiceResilienciaInfo').html('São necessários pelo menos 2 meses de dados');
        $('#valorEstabilidadeFinanceira').html('');
        return;
    }
    
    // Calcular a média dos resultados mensais
    var mediaResultados = resultadosMensais.reduce(function(a, b) { return a + b; }, 0) / resultadosMensais.length;
    
    // Calcular a variação percentual mês a mês
    var variacoesPercentuais = [];
    for (var i = 1; i < resultadosMensais.length; i++) {
        if (resultadosMensais[i-1] !== 0) {
            var variacao = Math.abs(((resultadosMensais[i] / resultadosMensais[i-1]) - 1) * 100);
            variacoesPercentuais.push(variacao);
        }
    }
    
    // Calcular a média das variações mensais (quanto menor, mais estável)
    var mediaVariacoes = variacoesPercentuais.length > 0 ? 
        variacoesPercentuais.reduce(function(a, b) { return a + b; }, 0) / variacoesPercentuais.length : 0;
    
    // Formatter para exibição de valores monetários
    var formatter = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2
    });
    
    // Adicionar informação sobre o período analisado
    var periodoTexto = "Últimos " + Math.min(12, resultadosMensais.length) + " meses";
    $('#valorEstabilidadeFinanceira').html('Média mensal: ' + formatter.format(mediaResultados) + 
        ' (' + periodoTexto + ')');
    
    // Converter para um índice de 0-100 (quanto menor a variação, maior o índice)
    // Para variações mensais, usamos um limite máximo menor (25% em vez de 50%)
    var indiceResiliencia = Math.max(0, Math.min(100, 100 - (mediaVariacoes * 4)));
    
    var classeResiliencia = '';
    var mensagemResiliencia = '';
    
    if (indiceResiliencia >= 80) {
        classeResiliencia = 'text-success';
        mensagemResiliencia = 'Altamente estável';
    } else if (indiceResiliencia >= 60) {
        classeResiliencia = 'text-success';
        mensagemResiliencia = 'Estável';
    } else if (indiceResiliencia >= 40) {
        classeResiliencia = 'text-warning';
        mensagemResiliencia = 'Moderadamente estável';
    } else if (indiceResiliencia >= 20) {
        classeResiliencia = 'text-danger';
        mensagemResiliencia = 'Volátil';
    } else {
        classeResiliencia = 'text-danger';
        mensagemResiliencia = 'Altamente volátil';
    }
    
    $('#indiceResilienciaValor').html('<span class="' + classeResiliencia + '">' + 
        indiceResiliencia.toFixed(0) + '/100</span>');
    
    // Explicação didática do cálculo
    var explicacaoResiliencia = 'Variação média mensal: ' + mediaVariacoes.toFixed(1) + '%';
    $('#indiceResilienciaInfo').html(mensagemResiliencia + 
        '<span style="display: block; font-size: 10px; color: #888; margin-top: 3px;">' + 
        explicacaoResiliencia + '</span>');
}

// Inicializa os elementos dos modais
$(document).ready(function() {
    // Inicializa os tooltips e popovers
    $('[data-toggle="tooltip"]').tooltip();
    
    // Garante que os modais funcionem corretamente
    $('.tooltip-info').click(function(e) {
        var targetModal = $(this).data('target');
        if (targetModal && targetModal.indexOf('#modal') === 0) {
            e.preventDefault();
            e.stopPropagation(); // Impedir propagação do evento
            $(targetModal).modal({
                backdrop: true,
                keyboard: true,
                show: true
            });
            return false; // Impedir comportamento padrão
        }
    });
    
    // Configurar opções globais de modais
    $('.modal').modal({
        show: false,
        backdrop: 'static' // Previne fechamento ao clicar fora (opcional)
    });
});

</script>

<!-- Atualizar os estilos CSS para melhorar a aparência -->
<style>
/* Estilos base aprimorados */
.dashboard-panel {
  transition: all 0.3s ease;
}

.dashboard-panel:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.modern-heading {
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.modern-box {
  background: #ffffff;
  transition: all 0.3s ease;
  border: 1px solid rgba(0,0,0,0.05);
}

.modern-box:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

/* Estilo para números animados - melhorado */
.animated-number, .count-animation {
    animation: fadeIn 0.8s ease-out;
    position: relative;
    display: inline-block;
}

.count-animation::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 25%;
    width: 50%;
    height: 2px;
    background: linear-gradient(90deg, 
        rgba(58,123,213,0.1) 0%, 
        rgba(58,123,213,0.6) 50%, 
        rgba(58,123,213,0.1) 100%);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Animação do background - aprimorada */
.animated-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(255,255,255,0) 20%, 
        rgba(255,255,255,0.15) 40%, 
        rgba(255,255,255,0) 60%);
    animation: shine 4s infinite;
    z-index: 0;
}

@keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Efeito de brilho na barra de progresso - aprimorado */
.progress-glow {
    position: absolute;
    top: 0;
    height: 100%;
    width: 60px;
    background: linear-gradient(90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.5) 50%,
        rgba(255,255,255,0) 100%);
    animation: progressShine 2s infinite;
    z-index: 2;
}

@keyframes progressShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(400%); }
}

/* Cores para textos - alinhadas com esquema de cores atualizado */
.text-success {
    color: #3a7bd5;
}

.text-danger {
    color: #ed5565;
}

.text-warning {
    color: #f8ac59;
}

/* Estilo para o ícone pulsante - suavizado */
.pulse-icon {
    animation: pulse 3s infinite;
    display: inline-block;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Estilo para animação da barra de progresso - suavizado */
.progress-animated {
    transition: width 1.8s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    overflow: hidden;
}

/* Estilos para cards com hover - aprimorado */
.card-tech {
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    border: 1px solid rgba(0,0,0,0.02);
}

.card-tech:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    border-color: rgba(58,123,213,0.1);
}

/* Efeito de brilho para textos - aprimorado */
.glow-text {
    display: inline-block;
    transition: all 0.3s ease;
}

.glow-text:hover {
    text-shadow: 0 0 5px rgba(58,123,213,0.5);
}

/* Highlight para valores principais - alinhado com esquema de cores */
.highlight-value {
    position: relative;
    display: inline-block;
}

.highlight-value::after {
    content: "";
    position: absolute;
    bottom: -3px;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, 
        rgba(58,123,213,0.2) 0%, 
        rgba(58,123,213,0.8) 50%, 
        rgba(58,123,213,0.2) 100%);
}

/* Estilos para os cards de insights - aprimorado */
#insightsAvancados .card-tech {
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

#insightsAvancados .card-tech:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

#insightsAvancados .card-tech::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #3a7bd5, #00d2ff);
    opacity: 0;
    transition: opacity 0.3s ease;
}

#insightsAvancados .card-tech:hover::before {
    opacity: 1;
}

/* Animação para tooltips e modais */
.tooltip-info i {
    transition: all 0.3s ease;
}

.tooltip-info:hover i {
    transform: scale(1.2);
    color: #00d2ff;
}

/* Estilização para tabelas */
.table-bordered {
    border-radius: 6px;
    overflow: hidden;
}

.table-striped > tbody > tr:nth-of-type(odd) {
    background-color: rgba(58,123,213,0.03);
}
</style>
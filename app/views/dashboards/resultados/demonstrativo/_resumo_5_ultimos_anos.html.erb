<div class="col-lg-12 no-padding">
  <div class="panel panel-default" style="margin-bottom: 10px !important">
  <div class="panel-heading" style="margin-top: -6px !important; padding-left: 10px" id="categoria_tabela">
        Resultado Anual
    <div class="panel-body no-padding">
      <div class="col-lg-12 padding-left-right">
        <div id="fatReceitaAnos" class="col-md-12 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box">            
              <div class="ibox-content padding-5">
                  <div id="desc_receitas_anos"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Início do bloco de indicadores visuais -->
          <div id="indicadoresVisuais" class="col-md-12 padding-5" style="display:none; margin-top: 20px;">
            <div class="ibox" style="margin-top: 15px; margin-bottom: 0; max-height: 150px;">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); overflow: hidden; position: relative; transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%); height: 100%;">
                <!-- Fundo com gradiente e efeito -->
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(26,179,148,0.03) 0%, rgba(26,179,148,0.08) 100%); z-index: 0;"></div>
                <div class="animated-background"></div>
                
                <div class="row" style="position: relative; z-index: 1; height: 100%;">
                  <div class="col-xs-8">
                    <h3 class="no-margins" style="font-size: 16px; color: #676a6c; font-weight: 600;">
                      <i class="fa fa-line-chart pulse-icon" style="margin-right: 5px; color: #1ab394;"></i> 
                      RESULTADO ANUAL <span id="ano-atual-resultado" style="font-weight: 700;"></span>
                    </h3>
                    
                    <!-- Div separadora para criar espaço visual -->
                    <div style="height: 15px;"></div>
                    
                    <h2 id="resultadoPrevia" class="no-margins highlight-value" style="font-size: 28px; color: #1ab394; font-weight: 700; letter-spacing: -0.5px;"></h2>
                    
                    <div class="row" style="margin-top: 12px;">
                      <div class="col-xs-12">
                        <div style="display: flex; align-items: center;">
                          <div class="progress" style="height: 10px; margin-bottom: 0; flex-grow: 1; border-radius: 20px; background-color: rgba(220,220,220,0.3); box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);">
                            <div id="progressoMeta" class="progress-bar progress-animated" style="width: 0%; border-radius: 20px; background: linear-gradient(90deg, #1ab394 0%, #21d8b5 100%);"></div>
                          </div>
                          <span id="porcentagem-meta" style="margin-left: 8px; font-size: 12px; color: #676a6c; min-width: 40px; text-align: right;"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-xs-4 text-right">
                    <div id="goal-indicator" style="background-color: rgba(100,149,237,0.1); padding: 10px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05);">
                      <div style="font-size: 12px; color: #676a6c;">META <span id="ano-meta"></span></div>
                      <div id="metaAnual" class="highlight-value" style="font-size: 14px; font-weight: 600; color: #4682B4;"></div>
                      <div style="margin-top: 5px; display: flex; align-items: center; justify-content: flex-end;">
                        <div style="font-size: 11px; color: #676a6c; margin-right: 5px;">Probabilidade:</div>
                        <div id="probabilidadeMeta" class="glow-text" style="font-size: 13px; font-weight: 600;"></div>
                      </div>
                    </div>
                    <div style="font-size: 12px; margin-bottom: 3px;">
                      <span id="comparativoAnoAnterior" style="color: #676a6c;"></span>
                    </div>
                    <p id="percentualComparativo" class="glow-text" style="font-size: 12px; margin-bottom: 0;"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Fim do bloco de indicadores visuais -->
          
        </div>
     </div>
  </div>
</div>
</div>


<script>
function drawTableResumoAnual() {
    $.getJSON("/dashboards/get_resumo_ultimos_5_anos?empresa=" + $('#empresas_financeiro_id').val(), function(data)
    {
         var datatable = new google.visualization.DataTable();

         var now = new Date;
         var mes_a_considerar =  now.getMonth()
          if(mes_a_considerar == 0){
              mes_a_considerar = 1
          }
         datatable.addColumn('string', 'Tipo');
         for (var i = 0; i < data.length; i++) {
             if (data[i].ano == now.getFullYear()) {
                 datatable.addColumn('number',data[i].ano +'(prévia)');
             } else {
                 datatable.addColumn('number', data[i].ano);
             }
         }

         datatable.addRow(['RECEITAS', parseFloat(data[0].receita), parseFloat(data[1].receita),parseFloat(data[2].receita),
             parseFloat(data[3].receita),parseFloat(data[4].receita)]);
         datatable.addRow(['DESPESAS', parseFloat(data[0].despesa), parseFloat(data[1].despesa),parseFloat(data[2].despesa),
            parseFloat(data[3].despesa),parseFloat(data[4].despesa)]);
         datatable.addRow(['RESULTADOS', parseFloat(data[0].resultado), parseFloat(data[1].resultado),parseFloat(data[2].resultado),
            parseFloat(data[3].resultado),parseFloat(data[4].resultado)]);
         datatable.addRow(['FATURAMENTO MENSAL', parseFloat(data[0].mediamensal),parseFloat(data[1].mediamensal),
            parseFloat(data[2].mediamensal),parseFloat(data[3].mediamensal),parseFloat(data[4].resultadosemmesatual / mes_a_considerar)]);

        for (var i=0; i < 4; i++){
             datatable.setRowProperty(i, 'className', 'h0');
         }
        //Faz a estilização das últimas duas linhas
        datatable.setRowProperty(2, 'className','bold-green-font');
        datatable.setRowProperty(3, 'className','bold-green-font');
        //Sobrescreve a estilização acima apenas das primeiras célulaspara que as mesmas fiquem em preto e negrito
        //ao invés de verde
        datatable.setCell(2 , 0, 'Resultado', 'RESULTADO LÍQUIDO DO EXERCÍCIO' , {'className':'blackcolor'});
        datatable.setCell(3 , 0, 'MÉDIA DE FATURAMENTO MENSAL', 'MÉDIA DE LUCRO LÍQUIDO MENSAL' , {'className':'blackcolor'});

        var table = new google.visualization.Table(document.getElementById('desc_receitas_anos'));

         var formatter = new google.visualization.NumberFormat(
             {prefix: 'R$ ', negativeColor: 'red', negativeParens: true});
         for (var k = 1; k < 6; k++) {
             formatter.format(datatable, k);
         }
         $('#fatReceitaAnos').show();
         table.draw(datatable, {allowHtml: true, width: '100%', height: '100%', frozenColumns:1});
         
         // Renderiza os indicadores visuais com os dados disponíveis
         renderizarIndicadoresVisuais(data);
     });
}

// Função para renderizar os indicadores visuais
function renderizarIndicadoresVisuais(data) {
    // Mostra o container dos indicadores com animação
    $('#indicadoresVisuais').fadeIn(800);
    
    // Obtém os dados do ano atual (prévia) e anterior
    var anoAtual = new Date().getFullYear();
    var indexAnoAtual = 0;
    var indexAnoAnterior = 1;
    
    // Procura os índices corretos nos dados
    for (var i = 0; i < data.length; i++) {
        if (data[i].ano == anoAtual) {
            indexAnoAtual = i;
        } else if (data[i].ano == (anoAtual - 1)) {
            indexAnoAnterior = i;
        }
    }
    
    // Valores para os cálculos
    var resultadoAtual = parseFloat(data[indexAnoAtual].resultado);
    var resultadoAnterior = parseFloat(data[indexAnoAnterior].resultado);
    var metaAnual = resultadoAnterior * 1.1; // Meta: 10% acima do ano anterior
    var anoAnterior = anoAtual - 1;
    
    // Exibe os anos
    $('#ano-atual-resultado').text(anoAtual + ' (Prévia)');
    $('#ano-meta').text(anoAtual);
    
    // Formata os valores para exibição
    var formatter = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2
    });
    
    // Aplicar os valores com animação
    setTimeout(function() {
        // Preenche o resultado atual (prévia)
        $('#resultadoPrevia').html(formatter.format(resultadoAtual))
            .addClass('animated-number');
        
        // Preenche o meta anual
        $('#metaAnual').html(formatter.format(metaAnual))
            .addClass('animated-number');
        
        // Preenche o comparativo com ano anterior
        $('#comparativoAnoAnterior').html(anoAnterior + ': ' + formatter.format(resultadoAnterior))
            .addClass('animated-number');
        
        // Calcula a variação percentual
        var variacaoPercentual = ((resultadoAtual / resultadoAnterior) - 1) * 100;
        var sinalVariacao = variacaoPercentual >= 0 ? '+' : '';
        var classeVariacao = variacaoPercentual >= 0 ? 'text-success' : 'text-danger';
        
        // Preenche o indicador comparativo
        $('#percentualComparativo').html('<span class="' + classeVariacao + '">' + 
            sinalVariacao + variacaoPercentual.toFixed(1) + '%</span> vs ' + anoAnterior);
        
        // Calcula o progresso em relação à meta
        var progressoMeta = (resultadoAtual / metaAnual) * 100;
        progressoMeta = Math.min(100, progressoMeta);
        
        // Atualiza a barra de progresso
        $('#progressoMeta').css('width', progressoMeta + '%');
        $('#porcentagem-meta').text(progressoMeta.toFixed(0) + '%');
        
        // Probabilidade de atingir a meta
        var mesAtual = new Date().getMonth() + 1;
        var probabilidadeMeta = 0;
        
        if (mesAtual > 0) {
            // Projeção simples baseada na proporção do ano
            var resultadoProjetado = (resultadoAtual / mesAtual) * 12;
            probabilidadeMeta = (resultadoProjetado / metaAnual) * 100;
            probabilidadeMeta = Math.min(100, probabilidadeMeta);
        }
        
        // Define a classe de cor para a probabilidade
        var classeProbabilidade = probabilidadeMeta >= 90 ? 'text-success' : 
                              (probabilidadeMeta >= 70 ? 'text-warning' : 'text-danger');
                              
        $('#probabilidadeMeta').html('<span class="' + classeProbabilidade + '">' + 
            probabilidadeMeta.toFixed(0) + '%</span>');
    }, 200);
}

</script>

<!-- Adiciona estilos CSS para os indicadores visuais -->
<style>
/* Estilo para números animados */
.animated-number {
    animation: fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Animação do background */
.animated-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(255,255,255,0) 20%, 
        rgba(255,255,255,0.15) 40%, 
        rgba(255,255,255,0) 60%);
    animation: shine 3s infinite;
    z-index: 0;
}

@keyframes shine {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

/* Cores para textos */
.text-success {
    color: #1ab394;
}

.text-danger {
    color: #ed5565;
}

.text-warning {
    color: #f8ac59;
}

/* Estilo para o ícone pulsante */
.pulse-icon {
    animation: pulse 2s infinite;
    display: inline-block;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Estilo para animação da barra de progresso */
.progress-animated {
    transition: width 1.5s ease-in-out;
    position: relative;
    overflow: hidden;
}

.progress-animated::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.3) 50%, 
        rgba(255,255,255,0) 100%);
    animation: shimmer 2s infinite;
    transform: translateX(-100%);
}

@keyframes shimmer {
    100% { transform: translateX(100%); }
}

/* Estilos para cards com hover */
.card-tech {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card-tech:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.1);
}

/* Efeito de brilho para textos */
.glow-text {
    display: inline-block;
    transition: all 0.3s ease;
}

.glow-text:hover {
    text-shadow: 0 0 5px rgba(26,179,148,0.5);
}

/* Highlight para valores principais */
.highlight-value {
    position: relative;
    display: inline-block;
}

.highlight-value::after {
    content: "";
    position: absolute;
    bottom: -3px;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, 
        rgba(26,179,148,0.2) 0%, 
        rgba(26,179,148,0.8) 50%, 
        rgba(26,179,148,0.2) 100%);
}
</style>
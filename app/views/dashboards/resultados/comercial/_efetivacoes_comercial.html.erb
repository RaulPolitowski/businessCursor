<div class="col-lg-12 no-padding">
  <div class="panel panel-default" style="margin-bottom: 10px !important;">
    <div class="panel-heading">
      Efetivações
    </div>
    <div class="panel-body no-padding">
      <div class="col-lg-12 no-padding" >
        <div id="efeDiv"class="col-md-3 padding-5">
          <div class="col-lg-12 padding-left-right">
            <div class="ibox" style="cursor: pointer" onclick="carregarInfoEfetivacoes(true)">
              <div class="ibox-content product-box">
                <div class="ibox-title ibox-title-without-border-style">
                  <h5>Quant. Efetivações</h5>
                  <span class="label label-info pull-right" id="competencia_total_efetivacoes"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 55px !important;">
                  <div class="col-lg-8 no-padding">
                    <h2 class="pull-left" id="total_efetivacoes_quantidade" style="margin-bottom: 3px"></h2>
                  </div>
                  <div class="col-lg-4 no-padding">
                    <div class="col-lg-12 no-padding">
                      <div class="stat-percent font-bold text-danger" id="percentual_total_efetivacoes_quantidade"></div>
                    </div>
                    <div class="col-lg-12 no-padding">
                      <div class="pull-right">
                        <small id="quantidade_efetivacoes_total"></small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12 padding-left-right">
            <div class="ibox" style="cursor: pointer" onclick="carregarInfoEfetivacoes(true)">
              <div class="ibox-content product-box">
                <div class="ibox-title ibox-title-without-border-style">
                  <h5>Mensalidade Efetivações</h5>
                  <span class="label label-info pull-right" id="competencia_mensalidade_efetivacoes"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 65px !important;">
                  <div class="col-lg-6 no-padding">
                    <div class="col-lg-12 no-padding">
                      <h2 class="pull-left" id="mensalidade_efetivacoes" style="margin-bottom: 2px !important;"></h2>
                    </div>
                    <small class="pull-left" id="media_mensalidade_efetivacoes"></small>
                  </div>
                  <div class="col-lg-6 no-padding">
                    <div class="col-lg-12 no-padding">
                      <div class="pull-right" id="mensalidade_efetivacoes_anterior" style="margin-bottom: 7px"></div>
                    </div>
                    <div class="stat-percent font-bold text-danger" id="percentual_mensalidade_efetivacoes"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12 padding-left-right">
            <div class="ibox" style="cursor: pointer" onclick="carregarInfoEfetivacoes(true)">
              <div class="ibox-content product-box">
                <div class="ibox-title ibox-title-without-border-style">
                  <h5>Instalação Efetivações</h5>
                  <span class="label label-info pull-right" id="competencia_instalacao_efetivacoes"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 65px !important;">
                  <div class="col-lg-6 no-padding">
                    <div class="col-lg-12 no-padding">
                      <h2 class="pull-left" id="instalacao_efetivacoes" style="margin-bottom: 2px !important;"></h2>
                    </div>
                    <small class="pull-left" id="media_instalacao_efetivacoes"></small>
                  </div>
                  <div class="col-lg-6 no-padding">
                    <div class="col-lg-12 no-padding">
                      <div class="pull-right" id="instalacao_efetivacoes_anterior" style="margin-bottom: 7px"></div>
                    </div>
                    <div class="stat-percent font-bold text-danger" id="percentual_instalacao_efetivacoes"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--<div class="col-lg-12 padding-left-right">-->
            <!--<div class="ibox" style="cursor: pointer" onclick="carregarInfoEfetivacoes(false)">-->
              <!--<div class="ibox-content product-box">-->
                <!--<div class="ibox-title ibox-title-without-border-style">-->
                  <!--<h5>Acompanhamentos concluídos</h5>-->
                  <!--<span class="label label-info pull-right" id="competencia_qtd_acompanhamentos"></span>-->
                <!--</div>-->
                <!--<div class="ibox-content padding-5" style="height: 55px !important;">-->
                  <!--<div class="col-lg-6 no-padding">-->
                    <!--<div class="col-lg-12 no-padding">-->
                      <!--<h2 class="pull-left" id="qtd_acompanhamentos" style="margin-bottom: 2px !important;"></h2>-->
                    <!--</div>-->
                    <!--&lt;!&ndash;<small class="pull-left" id="media_instalacao_efetivacoes"></small>&ndash;&gt;-->
                  <!--</div>-->
                  <!--<div class="col-lg-6 no-padding">-->
                    <!--<div class="col-lg-12 no-padding">-->
                      <!--<div class="pull-right" id="qtd_acompanhamentos_anterior" style="margin-bottom: 7px"></div>-->
                    <!--</div>-->
                    <!--<div class="stat-percent font-bold text-danger" id="percentual_qtd_acompanhamentos"></div>-->
                  <!--</div>-->
                <!--</div>-->
              <!--</div>-->
            <!--</div>-->
          <!--</div>-->
        </div>
        <div class="col-md-7 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box">
              <div class="ibox-title ibox-title-without-border-style">
                <span class="label label-info pull-right">Anual</span>
                <h5>Efetivações</h5>
              </div>
              <div class="ibox-content padding-5">
                <div id="efetivacoes_concluidas_12_meses" style="height: 240px !important;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box">
              <div class="ibox-title ibox-title-without-border-style">
                <span class="label label-info pull-right" id="compentencia_efetivacoes_sistema"></span>
                <h5>Por Sistema</h5>
              </div>
              <div class="ibox-content padding-5">
                <div id="efetivacoes_concluidas_sistema"  style="height: 240px !important;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <%= render 'dashboards/resultados/comercial/tabela/tabela_efetivacoes' %>
    </div>
  </div>
</div>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.19/sorting/date-eu.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.19/sorting/date-euro.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    google.charts.load('49', {'packages':['corechart','table']});
  })
    function drawAcompanhamentos12Meses() {
        $.getJSON("/dashboards/acompanhamentos_concluidos_12_meses?empresa=" + $('#empresas_financeiro_id').val() +
            "&estado=" + $('#estado_financeiro_id').val() +
            "&vendedor=" + $('#vendedor_id').val() +
            "&implantador=" + $('#implantador_id').val() , function(data) {
            var dataArray = [
                ['Mês', 'Quantidade', 'Quantidade', 'Implantação', 'Mensalidade', 'Média Implantação', 'Média Mensalidade',
                    'Emissor', 'Gourmet', 'Manager', 'Light', 'Total acomp.', 'Outros']
            ];
            for (var i = 0; i < data.length; i++) {
                var row = [data[i].data, parseInt(data[i].quantidade), parseInt(data[i].quantidade),
                    parseFloat(data[i].implantacao), parseFloat(data[i].mensalidade),
                    parseFloat(data[i].mediaimplantacao), parseFloat(data[i].mediamensalidade),
                    data[i].emissor, data[i].gourmet, data[i].manager, data[i].light, parseInt(data[i].total_acomp), data[i].outros ];
                dataArray.push(row);
            }

            var meses = data;
            var result = null;
            $.getJSON("/dashboards/acompanhamentos_concluidos_12_meses_mes_anterior?empresa=" + $('#empresas_financeiro_id').val() +
                "&estado=" + $('#estado_financeiro_id').val() +
                "&vendedor=" + $('#vendedor_id').val() +
                "&implantador=" + $('#implantador_id').val(), function(ret) {

                result = ret;

                preencherAcompanhamentoConcluida($(meses).get(-1).data,
                                                 $(meses).get(-1).quantidade,
                    parseFloat($(meses).get(-1).mensalidade),
                    parseFloat($(meses).get(-1).implantacao),
                    parseFloat($(meses).get(-1).mediamensalidade),
                    parseFloat($(meses).get(-1).mediaimplantacao),
                    $(result).get(-1).quantidade,
                    parseFloat($(result).get(-1).mensalidade),
                    parseFloat($(result).get(-1).implantacao),
                    parseInt($(meses).get(-1).total_acomp),
                    parseInt($(result).get(-1).total_acomp));
            });

            drawChartAcompanhamentoSistema($(meses).get(-1).emissor, $(meses).get(-1).gourmet, $(meses).get(-1).manager, $(meses).get(-1).light, $(meses).get(-1).outros);

            $('#efeDiv').attr({title: "Dados aos quais comparam o fechamento do mês passado com o resultado até o dia atual."});
            
            var options = {
                'chartArea': {'width': '90%', 'height': '70%'},
                hAxis: {title: 'Mês',  textStyle: {fontSize: 9, color: 'blue'}},
                seriesType: 'bars',
                series: {1: {type: 'line', color: 'black'}},
                legend: 'none',
                animation: { easing: 'inAndOut', duration: 500, startup: true, displayLegendValues: false}
            };
            var chart = new google.visualization.ComboChart(document.getElementById('efetivacoes_concluidas_12_meses'));

            function selectHandler() {
                var selectedItem = chart.getSelection()[0];
                if (selectedItem) {
                    var ultimo = selectedItem.row-1;
                    if(ultimo == -1)
                        ultimo = 0;

                    preencherAcompanhamentoConcluida(data.getValue(selectedItem.row, 0),
                        data.getValue(selectedItem.row, 1),
                        data.getValue(selectedItem.row, 4),
                        data.getValue(selectedItem.row, 3),
                        data.getValue(selectedItem.row, 6),
                        data.getValue(selectedItem.row, 5),
                        data.getValue(ultimo, 1),
                        data.getValue(ultimo, 4),
                        data.getValue(ultimo, 3),
                        data.getValue(selectedItem.row, 11),
                        data.getValue(ultimo,11));

                    drawChartAcompanhamentoSistema(data.getValue(selectedItem.row, 7), data.getValue(selectedItem.row, 8), data.getValue(selectedItem.row, 9), data.getValue(selectedItem.row, 10), data.getValue(selectedItem.row, 12));
                    $('#efeDiv').attr({title: "Dados aos quais comparam o fechamento do mês inteiro."});
            
                }else{
                    preencherAcompanhamentoConcluida($(meses).get(-1).data,
                        $(meses).get(-1).quantidade,
                        parseFloat($(meses).get(-1).mensalidade),
                        parseFloat($(meses).get(-1).implantacao),
                        parseFloat($(meses).get(-1).mediamensalidade),
                        parseFloat($(meses).get(-1).mediaimplantacao),
                        $(result).get(-1).quantidade,
                        parseFloat($(result).get(-1).mensalidade),
                        parseFloat($(result).get(-1).implantacao),
                        parseInt($(meses).get(-1).total_acomp),
                        parseInt($(result).get(-1).total_acomp)
                    );

                    drawChartAcompanhamentoSistema($(meses).get(-1).emissor, $(meses).get(-1).gourmet, $(meses).get(-1).manager, $(meses).get(-1).light, $(meses).get(-1).outros);
                    $('#efeDiv').attr({title: "Dados aos quais comparam o fechamento do mês passado com o resultado até o dia atual."});
            
                }
                $('#bloco_efetivacoes').hide();
            }

            google.visualization.events.addListener(chart, 'select', selectHandler);

            var data = google.visualization.arrayToDataTable(dataArray);

            chart.draw(data, options);

            view = new google.visualization.DataView(data);
            view.hideColumns([3,4,5,6,7,8,9,10,11,12]);
            chart.draw(view, options);
        });
    }

    function preencherAcompanhamentoConcluida(competencia, quantidade, valorMensalidade, valorImplantacao, mediaMensalidade,
                                              mediaImplantacao, quantidadeAnterior, valorMensalidadeAnterior, valorImplantacaoAnterior, qtdAcomp, qtdAcompAnterior){

        $('#competencia_total_efetivacoes').text(competencia);
        $('#competencia_mensalidade_efetivacoes').text(competencia);
        $('#competencia_instalacao_efetivacoes').text(competencia);
        $('#competencia_qtd_acompanhamentos').text(competencia);

        $('#total_efetivacoes_quantidade').text('Total ' + quantidade);
        $('#quantidade_efetivacoes_total').text('Ant. ' + quantidadeAnterior);
        var valor = ((quantidade*100 / quantidadeAnterior)-100);
        $('#percentual_total_efetivacoes_quantidade').text('');
        if(valor > 0){
            $('#percentual_total_efetivacoes_quantidade').removeClass('text-danger').addClass('text-info');
            $('#percentual_total_efetivacoes_quantidade').append(valor.toFixed(2)+'% <i class="fa fa-level-up"></i>');
        }else{
            $('#percentual_total_efetivacoes_quantidade').removeClass('text-info').addClass('text-danger');
            $('#percentual_total_efetivacoes_quantidade').append(valor.toFixed(2)+'% <i class="fa fa-level-down"></i>');
        }

        $('#mensalidade_efetivacoes').text(mascaraValor(valorMensalidade.toFixed(2)));
        $('#media_mensalidade_efetivacoes').text('Média ' + mascaraValor(mediaMensalidade.toFixed(2)));
        $('#mensalidade_efetivacoes_anterior').text('Ant. ' + mascaraValor(valorMensalidadeAnterior.toFixed(2)));
        var valor = ((valorMensalidade*100 / valorMensalidadeAnterior)-100);

        $('#percentual_mensalidade_efetivacoes').text('');
        if(valor > 0){
            $('#percentual_mensalidade_efetivacoes').removeClass('text-danger').addClass('text-info');
            $('#percentual_mensalidade_efetivacoes').append(valor.toFixed(2)+'% <i class="fa fa-level-up"></i>');
        }else{
            $('#percentual_mensalidade_efetivacoes').removeClass('text-info').addClass('text-danger');
            $('#percentual_mensalidade_efetivacoes').append(valor.toFixed(2)+'% <i class="fa fa-level-down"></i>');
        }

        $('#instalacao_efetivacoes').text(mascaraValor(valorImplantacao.toFixed(2)));
        $('#media_instalacao_efetivacoes').text('Média ' + mascaraValor(mediaImplantacao.toFixed(2)));
        $('#instalacao_efetivacoes_anterior').text('Ant. ' + mascaraValor(valorImplantacaoAnterior.toFixed(2)));
        var valor = ((valorImplantacao*100 / valorImplantacaoAnterior)-100);
        $('#percentual_instalacao_efetivacoes').text('');
        if(valor > 0){
            $('#percentual_instalacao_efetivacoes').removeClass('text-danger').addClass('text-info');
            $('#percentual_instalacao_efetivacoes').append(valor.toFixed(2)+'% <i class="fa fa-level-up"></i>');
        }else{
            $('#percentual_instalacao_efetivacoes').removeClass('text-info').addClass('text-danger');
            $('#percentual_instalacao_efetivacoes').append(valor.toFixed(2)+'% <i class="fa fa-level-down"></i>');
        }

        $('#qtd_acompanhamentos').text('Total ' + qtdAcomp);
        $('#qtd_acompanhamentos_anterior').text('Ant. ' + qtdAcompAnterior);
        var valor = ((qtdAcomp*100 / qtdAcompAnterior)-100);
        $('#percentual_qtd_acompanhamentos').text('');
        if(valor > 0){
            $('#percentual_qtd_acompanhamentos').removeClass('text-danger').addClass('text-info');
            $('#percentual_qtd_acompanhamentos').append(valor.toFixed(2)+'% <i class="fa fa-level-up"></i>');
        }else{
            $('#percentual_qtd_acompanhamentos').removeClass('text-info').addClass('text-danger');
            $('#percentual_qtd_acompanhamentos').append(valor.toFixed(2)+'% <i class="fa fa-level-down"></i>');
        }
    }

    function drawChartAcompanhamentoSistema(emissor, gourmet, manager, light, outros) {
        var dataArray = [
            ['Sistema', 'Quantidade'],
        ];
        dataArray.push(['Emissor', parseInt(emissor)]);
        dataArray.push(['Gourmet', parseInt(gourmet)]);
        dataArray.push(['Manager', parseInt(manager)]);
        dataArray.push(['Light', parseInt(light)]);
        dataArray.push(['Outros', parseInt(outros)]);
        var options = {
            'chartArea': {'width': '100%', 'height': '80%'},
            pieStartAngle: 50,
            legend: {position: 'bottom'},
            is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('efetivacoes_concluidas_sistema'));
        var data = google.visualization.arrayToDataTable(dataArray);

        chart.draw(data, options);
    }
    
    function carregarInfoEfetivacoes(efetivacao) {
        if($('#bloco_efetivacoes').is(':visible')){
            $('#bloco_efetivacoes').hide();
        }else{
            $.getJSON("/dashboards/table_efetivacoes?empresa=" + $('#empresas_financeiro_id').val() +
                "&estado=" + $('#estado_financeiro_id').val() +
                "&data=" + $('#competencia_total_efetivacoes').text() +
                "&efetivacao=" + efetivacao +
                "&vendedor=" + $('#vendedor_id').val() +
                "&implantador=" + $('#implantador_id').val() , function(data) {

                $('#bloco_efetivacoes').show();
                var table = $('.table-efetivacoes').DataTable();
                table.clear().draw();
                $.each(data,function (i,val){
                    table.row.add( [
                        moment(val['data_fim']).format("DD/MM/YYYY HH:mm"),
                        val['razao_social'],
                        val['cidade'],
                        val['sistema'],
                        val['implantador'],
                        val['vendedor'],
                        humanBoolean(val['honorario_cadastrado']),
                        mascaraValor(val['mensalidade']),
                        mascaraValor(val['implantacao'])
                    ] ).draw( false );
                });
            });
        }
    }
</script>
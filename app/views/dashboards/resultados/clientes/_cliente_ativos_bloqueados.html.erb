<div class="col-lg-12 no-padding">
  <div class="panel panel-default dashboard-main-panel" style="margin-bottom: 15px !important; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(248,250,252,0.95) 100%); overflow: hidden;">
    <div class="panel-heading" style="height: 50px; background: linear-gradient(to right, #f3f3f4, #ffffff); border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; padding: 0 15px;">
      <span style="font-weight: 600; color: #333; display: flex; align-items: center;">
        <i class="fa fa-users" style="color: #1ab394; margin-right: 8px; font-size: 16px;"></i>
        <span style="text-transform: uppercase; letter-spacing: 0.5px;">Clientes Ativos x Bloqueados</span>
      </span>
      <div class="col-sm-2 pull-right" id="grafico_por">
        <%= select_tag  'filtro_grafico', options_for_select([
                                                             ['Por sistema - tabela', 5],
                                                             ['Por sistema', 1],
                                                             ['Por status', 2],
                                                             ['Ticket Médio', 3],
                                                             ['Por UF', 4]
                                                             ], 5), {:class => "form-control input-sm chosen-select", style: "border-radius: 20px; border: none; background: rgba(255,255,255,0.8); box-shadow: 0 2px 5px rgba(0,0,0,0.05);"} %>
      </div>
    </div>
    <div class="panel-body no-padding">
      <div class="col-lg-12 padding-left-right">
        <div class="col-md-3 padding-5" style="display: flex; flex-direction: column; height: 100%; gap: 27px;">
          <div class="col-lg-12 padding-left-right">
            <div class="ibox" style="cursor: pointer" onclick="carregarInfoClientesAtivos()">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-left: 4px solid #1ab394; transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(245,249,250,1) 100%);">
                <div class="ibox-title ibox-title-without-border-style" style="padding-bottom: 10px;">
                  <h5 style="font-weight: 600; position: relative; z-index: 1;">
                    <i class="fa fa-check-circle pulse-icon" style="color: #1ab394; margin-right: 8px;"></i>CLIENTES ATIVOS - REAL
                  </h5>
                  <span class="label label-info pull-right tech-badge" id="compentencia_cliente" style="background-color: #1ab394; font-size: 11px; padding: 2px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(26,179,148,0.3);"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 50px !important; border-top: 1px solid rgba(0,0,0,0.05);">
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-left highlight-value" id="clientes_ativos_real"></h2>
                  </div>
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-right highlight-value" id="valor_clientes_ativos_real" style="margin-bottom: 3px; margin-top: 0px !important; color: #1ab394;"></h2>
                    <small class="pull-right" id="media_clientes_ativos_real" style="color: #888888;"></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12 padding-left-right">
            <div class="ibox" style="cursor: pointer" onclick="carregarInfoClientesBloqueados('BLOQUEADO')">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-left: 4px solid #ed5565; transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(250,245,245,1) 100%);">
                <div class="ibox-title ibox-title-without-border-style" style="padding-bottom: 10px;">
                  <h5 style="font-weight: 600; position: relative; z-index: 1;">
                    <i class="fa fa-ban pulse-icon" style="color: #ed5565; margin-right: 8px;"></i>BLOQUEADOS (+7 DIAS)
                  </h5>
                  <span class="label label-info pull-right tech-badge" id="compentencia_cliente_bloqueados" style="background-color: #ed5565; font-size: 11px; padding: 2px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(237,85,101,0.3);"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 50px !important; border-top: 1px solid rgba(0,0,0,0.05);">
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-left highlight-value" id="clientes_ativos_bloqueados"></h2>
                  </div>
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-right highlight-value" id="valor_clientes_ativos_bloqueados" style="margin-bottom: 3px; margin-top: 0px !important; color: #ed5565;"></h2>
                    <small class="pull-right" id="media_clientes_ativos_bloqueados" style="color: #888888;"></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id= "card_bloqueados_atualmente" class="col-lg-12 padding-left-right">
            <div class="ibox" style="cursor: pointer" onclick="carregarInfoClientesBloqueadosAtualmente()">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-left: 4px solid #f8ac59; transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(252,248,245,1) 100%);">
                <div class="ibox-title ibox-title-without-border-style" style="padding-bottom: 10px;">
                  <h5 style="font-weight: 600; position: relative; z-index: 1;">
                    <i class="fa fa-clock-o pulse-icon" style="color: #f8ac59; margin-right: 8px;"></i>BLOQUEADOS (-7 DIAS)
                  </h5>
                  <span class="label label-info pull-right tech-badge" id="compentencia_cliente_bloqueados_atualmente" style="background-color: #f8ac59; font-size: 11px; padding: 2px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(248,172,89,0.3);"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 50px !important; border-top: 1px solid rgba(0,0,0,0.05);">
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-left highlight-value" id="clientes_ativos_bloqueados_atualmente"></h2>
                  </div>
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-right highlight-value" id="valor_clientes_ativos_bloqueados_atualmente" style="margin-bottom: 3px; margin-top: 0px !important; color: #f8ac59;"></h2>
                    <small class="pull-right" id="media_clientes_ativos_bloqueados_atualmente" style="color: #888888;"></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12 padding-left-right">
            <div class="ibox">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-left: 4px solid #1c84c6; transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%);">
                <div class="ibox-title ibox-title-without-border-style" style="padding-bottom: 10px;">
                  <h5 style="font-weight: 600; position: relative; z-index: 1;">
                    <i class="fa fa-users pulse-icon" style="color: #1c84c6; margin-right: 8px;"></i>CLIENTES TOTAL
                  </h5>
                  <span class="label label-info pull-right tech-badge" id="compentencia_cliente_total" style="background-color: #1c84c6; font-size: 11px; padding: 2px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(28,132,198,0.3);"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 50px !important; border-top: 1px solid rgba(0,0,0,0.05);">
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-left highlight-value" id="clientes_ativos_total"></h2>
                  </div>
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-right highlight-value" id="valor_clientes_ativos_total" style="margin-bottom: 3px; margin-top: 0px !important; color: #1c84c6;"></h2>
                    <small class="pull-right" id="media_clientes_ativos_total" style="color: #888888;"></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12 padding-left-right">
            <div class="ibox" style="cursor: pointer" onclick="carregarInfoClientesBloqueados('PARALISADO')">
              <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-left: 4px solid #9575cd; transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,245,252,1) 100%);">
                <div class="ibox-title ibox-title-without-border-style" style="padding-bottom: 10px;">
                  <h5 style="font-weight: 600; position: relative; z-index: 1;">
                    <i class="fa fa-pause-circle pulse-icon" style="color: #9575cd; margin-right: 8px;"></i>CLIENTES PARALISADOS
                  </h5>
                  <span class="label label-info pull-right tech-badge" id="compentencia_cliente_paralisados" style="background-color: #9575cd; font-size: 11px; padding: 2px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(149,117,205,0.3);"></span>
                </div>
                <div class="ibox-content padding-5" style="height: 50px !important; border-top: 1px solid rgba(0,0,0,0.05);">
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-left highlight-value" id="clientes_ativos_paralisados"></h2>
                  </div>
                  <div class="col-lg-6 no-padding">
                    <h2 class="pull-right highlight-value" id="valor_clientes_ativos_paralisados" style="margin-bottom: 3px; margin-top: 0px !important; color: #9575cd;"></h2>
                    <small class="pull-right" id="media_clientes_ativos_paralisados" style="color: #888888;"></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-7 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%);">
              <div class="ibox-title ibox-title-without-border-style" style="padding-bottom: 10px;">
                <h5 style="font-weight: 600; position: relative; z-index: 1;">
                  <i class="fa fa-line-chart pulse-icon" style="color: #1ab394; margin-right: 8px;"></i>
                  <span style="text-transform: uppercase; letter-spacing: 0.5px;">Clientes Ativos</span>
                </h5>
                <span class="label label-info pull-right tech-badge" style="background-color: #1ab394; font-size: 11px; padding: 2px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(26,179,148,0.3);">Anual</span>
              </div>
              <div class="ibox-content padding-5" style="border-top: 1px solid rgba(0,0,0,0.05);">
                <div id="clientes_12_meses" style="height: 290px !important;"></div>
                
                <!-- Indicadores de Crescimento -->
                <div class="growth-indicators-container">
                  <h4 class="text-center m-t-md" style="text-transform: uppercase; font-size: 14px; letter-spacing: 0.5px; color: #333; font-weight: 600;">Evolução do Crescimento</h4>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="stat-panel quarterly card-tech" style="border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 3px solid #1c84c6;">
                        <div class="stat-title">Últimos 3 Meses</div>
                        <div id="quarter-growth-clients" class="stat-value highlight-value" style="color: #1c84c6;">--</div>
                        <div id="quarter-growth-value" class="stat-subvalue">--</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="stat-panel yearly card-tech" style="border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 3px solid #f8ac59;">
                        <div class="stat-title">Mesmo Mês no Ano Anterior</div>
                        <div id="year-growth-clients" class="stat-value highlight-value" style="color: #f8ac59;">--</div>
                        <div id="year-growth-value" class="stat-subvalue">--</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2 padding-5">
          <div class="ibox">
            <div class="ibox-content product-box card-tech" style="border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; background: linear-gradient(120deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%);">
              <div class="ibox-title ibox-title-without-border-style" style="padding-bottom: 10px;">
                <h5 style="font-weight: 600; position: relative; z-index: 1;">
                  <i class="fa fa-pie-chart pulse-icon" style="color: #1c84c6; margin-right: 8px;"></i>
                  <span style="text-transform: uppercase; letter-spacing: 0.5px;">Clientes ativos</span>
                </h5>
                <span class="label label-info pull-right tech-badge" id="competencia_ativos_bloqueados" style="background-color: #1c84c6; font-size: 11px; padding: 2px 8px; border-radius: 20px; box-shadow: 0 2px 5px rgba(28,132,198,0.3);"></span>
              </div>
              <div class="ibox-content padding-5" style="border-top: 1px solid rgba(0,0,0,0.05);">
                <div id="ativos_bloqueados"  style="height: 483px !important;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <%= render 'dashboards/resultados/clientes/tabela/tabela_clientes_ativos' %>
      <%= render 'dashboards/resultados/clientes/tabela/tabela_clientes_bloqueados' %>
      <%= render 'dashboards/resultados/clientes/tabela/tabela_clientes_bloqueado_atualmente' %>
    </div>
  </div>
</div>

<style>
  .bold{
    font-weight: bold !important;    
  }
  .h30{
    height: 30px !important;
  }
  
  /* Estilo para os indicadores de crescimento */
  .growth-indicators-container {
    margin-top: 15px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 15px;
  }
  
  .growth-indicators-container h4 {
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
  
  .stat-panel {
    background-color: #fff;
    border-radius: 5px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    padding: 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
    margin-bottom: 10px;
    height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  
  .stat-panel::before {
    content: none !important;
  }
  
  .stat-panel.monthly::before {
    background-color: #1ab394;
  }
  
  .stat-panel.quarterly::before {
    background-color: #1c84c6;
  }
  
  .stat-panel.yearly::before {
    background-color: #f8ac59;
  }
  
  .stat-title {
    font-size: 14px;
    font-weight: 600;
    color: #676a6c;
    margin-bottom: 10px;
  }
  
  .stat-value {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 5px;
  }
  
  .stat-subvalue {
    font-size: 14px;
    color: #676a6c;
  }
  
  .value-increase {
    color: #336699;
  }
  
  .value-decrease {
    color: #993333;
  }
  
  .stat-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 5px;
  }
  
  .badge-increase {
    background-color: rgba(26, 179, 148, 0.15);
    color: #1ab394;
  }
  
  .badge-decrease {
    background-color: rgba(237, 85, 101, 0.15);
    color: #ed5565;
  }
  
  .badge-increase-subtle {
    background-color: rgba(72, 126, 176, 0.2);
    color: #336699;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.85em;
    font-weight: bold;
  }
  
  .badge-decrease-subtle {
    background-color: rgba(192, 96, 96, 0.2);
    color: #993333;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.85em;
    font-weight: bold;
  }

  /* Estilo para destacar valores principais */
  .highlight-value {
    position: relative;
    display: inline-block;
    z-index: 1;
    background: transparent !important; /* Garantir que não tenha background */
  }

  .highlight-value:after {
    display: none; /* Ocultar o pseudo-elemento que cria o fundo verde */
  }
  
  /* Remover qualquer efeito de fundo nos valores */
  h2.highlight-value, 
  .pull-left.highlight-value, 
  .pull-right.highlight-value {
    background: transparent !important;
    box-shadow: none !important;
  }
</style>

<script>
  // Inicializar os gráficos quando a página carregar
  $(document).ready(function() {
    // Garantir que a biblioteca do Google Charts esteja carregada
    if (typeof google !== 'undefined' && google.charts) {
      google.charts.load('current', {'packages':['corechart', 'table']});
      google.charts.setOnLoadCallback(function() {
        console.log("Google Charts carregado, iniciando drawClientes12Meses");
        drawClientes12Meses();
      });
    } else {
      console.log("Esperando Google Charts carregar...");
      setTimeout(function() {
        drawClientes12Meses();
      }, 1000);
    }
  });

  $('#grafico_por').on('change', function () {
    if ($('#filtro_grafico').val() == 2)
      drawClientes12Meses();
    else if ($('#filtro_grafico').val() == 3)
      drawTicketMedioClientesAtivos();
    else if ($('#filtro_grafico').val() == 4)
      drawClientesAtivosPorUF();
    else if ($('#filtro_grafico').val() == 5)
      drawTabelaAtivosBloqueadosSistema();
    else //1
      drawChartAtivosBloqueadosSistema();
  });

    function drawClientes12Meses() {
        console.log("Iniciando chamada para obter dados dos clientes");
        $.getJSON("/dashboards/get_cliente_12_meses?empresa=" + $('#empresas_financeiro_id').val() +
            "&estado=" + $('#estado_financeiro_id').val(), function(data) {

            console.log("Dados recebidos:", data.length, "registros");
            var meses = data;
            
            // Armazenar dados para análise
            window.dadosMensaisClientes = data.slice();

            var dataArray = [
                ['Mês', 'Quantidade', 'Quantidade', {type: 'string', role: 'annotation'}, 'Valor', 'Média',
                    'Total ativos', 'Valor ativos', 'Média ativos', 'Total bloqueados', 'Valor bloqueados', 'Média bloqueados',
                    'Total paralisados', 'Valor paralisados', 'Média paralisados'],
            ];
            for (var i = 0; i < data.length; i++) {
                var row = [meses[i].final, parseInt(meses[i].totalqtd), parseInt(meses[i].totalqtd),
                    parseInt(meses[i].totalqtd), parseFloat(meses[i].totalvalor), parseFloat(meses[i].totalmedia),
                    parseInt(meses[i].normalqtd), parseFloat(meses[i].normalvalor), parseFloat(meses[i].normalmedia),
                    parseInt(meses[i].bloqueadoqtd), parseFloat(meses[i].bloqueadovalor), parseFloat(meses[i].bloqueadomedia),
                    parseInt(meses[i].paralisadoqtd), parseFloat(meses[i].paralisadovalor), parseFloat(meses[i].paralisadomedia)];
                dataArray.push(row);
            }
            if(data.length > 0){
                preencherClientes($(meses).get(-1).final,
                    $(meses).get(-1).normalqtd, mascaraValor($(meses).get(-1).normalvalor), mascaraValor($(meses).get(-1).normalmedia),
                    $(meses).get(-1).bloqueadoqtd, mascaraValor($(meses).get(-1).bloqueadovalor), mascaraValor($(meses).get(-1).bloqueadomedia),
                    $(meses).get(-1).bloqueadoatualmenteqtd, mascaraValor($(meses).get(-1).bloqueadoatualmentevalor), mascaraValor($(meses).get(-1).bloqueadoatualmentemedia),
                    $(meses).get(-1).totalqtd, mascaraValor($(meses).get(-1).totalvalor), mascaraValor($(meses).get(-1).totalmedia),
                    $(meses).get(-1).paralisadoqtd, mascaraValor($(meses).get(-1).paralisadovalor), mascaraValor($(meses).get(-1).paralisadomedia));
                if ($('#filtro_grafico').val() == 2)
                    drawChartAtivosBloqueados($(meses).get(-1).normalqtd, $(meses).get(-1).bloqueadoqtd, $(meses).get(-1).paralisadoqtd);
                else if ($('#filtro_grafico').val() == 3)
                    drawTicketMedioClientesAtivos();
                else if ($('#filtro_grafico').val() == 5)
                    drawTabelaAtivosBloqueadosSistema();
                else
                    drawChartAtivosBloqueadosSistema();
                
                // Armazenar os dados dos últimos 12 meses em uma variável global para uso posterior
                window.dadosUltimos12Meses = data.slice();
                
                // Calcular indicadores de crescimento apenas na inicialização
                calcularEExibirIndicadoresCrescimento();
            }else{
                preencherClientes('', 0, mascaraValor('0.00'),
                    mascaraValor('0.00'), 0, mascaraValor('0.00'),
                    mascaraValor('0.00'), 0, mascaraValor('0.00'),
                    mascaraValor('0.00'), 0, mascaraValor('0.00'),
                    mascaraValor('0.00'));
                if ($('#filtro_grafico').val() == 2)    
                    drawChartAtivosBloqueados(0, 0, 0);
                else if ($('#filtro_grafico').val() == 3)
                    drawTicketMedioClientesAtivos();
                else if ($('#filtro_grafico').val() == 5)
                    drawTabelaAtivosBloqueadosSistema();
                else
                    drawChartAtivosBloqueadosSistema();
            }

            var options = {
                'chartArea': {'width': '90%', 'height': '70%'},
                hAxis: {title: 'Mês',  textStyle: {fontSize: 9, color: 'blue'}},
                seriesType: 'bars',
                series: {1: {type: 'line', color: 'black'}},
                legend: 'none',
                animation: { easing: 'inAndOut', duration: 500, startup: true, displayLegendValues: false}
            };
            var chart = new google.visualization.ComboChart(document.getElementById('clientes_12_meses'));

            function selectHandler() {
                var selectedItem = chart.getSelection()[0];
                if (selectedItem) {
                    var mesSelecionado = meses[selectedItem.row];
                    
                    preencherClientes($(meses).get(selectedItem.row).final,
                        $(meses).get(selectedItem.row).normalqtd, mascaraValor($(meses).get(selectedItem.row).normalvalor), mascaraValor($(meses).get(selectedItem.row).normalmedia),
                        $(meses).get(selectedItem.row).bloqueadoqtd, mascaraValor($(meses).get(selectedItem.row).bloqueadovalor), mascaraValor($(meses).get(selectedItem.row).bloqueadomedia),
                        $(meses).get(selectedItem.row).bloqueadoatualmenteqtd, mascaraValor($(meses).get(selectedItem.row).bloqueadoatualmentevalor), mascaraValor($(meses).get(selectedItem.row).bloqueadoatualmentemedia),
                        $(meses).get(selectedItem.row).totalqtd, mascaraValor($(meses).get(selectedItem.row).totalvalor), mascaraValor($(meses).get(selectedItem.row).totalmedia),
                        $(meses).get(selectedItem.row).paralisadoqtd, mascaraValor($(meses).get(selectedItem.row).paralisadovalor), mascaraValor($(meses).get(selectedItem.row).paralisadomedia));
                    if ($('#filtro_grafico').val() == 2)    
                        drawChartAtivosBloqueados($(meses).get(selectedItem.row).normalqtd, $(meses).get(selectedItem.row).bloqueadoqtd, $(meses).get(selectedItem.row).paralisadoqtd);
                    else if ($('#filtro_grafico').val() == 3)
                        drawTicketMedioClientesAtivos();
                    else if ($('#filtro_grafico').val() == 4)
                        drawClientesAtivosPorUF();
                    else if ($('#filtro_grafico').val() == 5)
                        drawTabelaAtivosBloqueadosSistema();
                    else
                        drawChartAtivosBloqueadosSistema();
                    if (selectedItem.row == 13) $('#card_bloqueados_atualmente').show();
                    else $('#card_bloqueados_atualmente').hide();
                    
                    // Não recalcular os indicadores de crescimento quando um mês for selecionado
                    // Manter os mesmos dados da última atualização
                }else{
                    preencherClientes($(meses).get(-1).final,
                        $(meses).get(-1).normalqtd, mascaraValor($(meses).get(-1).normalvalor), mascaraValor($(meses).get(-1).normalmedia),
                        $(meses).get(-1).bloqueadoqtd, mascaraValor($(meses).get(-1).bloqueadovalor), mascaraValor($(meses).get(-1).bloqueadomedia),
                        $(meses).get(-1).bloqueadoatualmenteqtd, mascaraValor($(meses).get(-1).bloqueadoatualmentevalor), mascaraValor($(meses).get(-1).bloqueadoatualmentemedia),
                        $(meses).get(-1).totalqtd, mascaraValor($(meses).get(-1).totalvalor), mascaraValor($(meses).get(-1).totalmedia),
                        $(meses).get(-1).paralisadoqtd, mascaraValor($(meses).get(-1).paralisadovalor), mascaraValor($(meses).get(-1).paralisadomedia));
                    if ($('#filtro_grafico').val() == 2)    
                        drawChartAtivosBloqueados($(meses).get(-1).normalqtd, $(meses).get(-1).bloqueadoqtd, $(meses).get(-1).paralisadoqtd);
                    else if ($('#filtro_grafico').val() == 3)
                        drawTicketMedioClientesAtivos();
                    else if ($('#filtro_grafico').val() == 4)
                        drawClientesAtivosPorUF();
                    else if ($('#filtro_grafico').val() == 5)
                        drawTabelaAtivosBloqueadosSistema();
                    else
                        drawChartAtivosBloqueadosSistema();
                    $('#card_bloqueados_atualmente').show();
                }
            }

            google.visualization.events.addListener(chart, 'select', selectHandler);

            var data = google.visualization.arrayToDataTable(dataArray);

            chart.draw(data, options);

            view = new google.visualization.DataView(data);
            view.hideColumns([4,5,6,7,8,9,10,11,12,13,14]);
            chart.draw(view, options);
        }).fail(function(jqxhr, textStatus, error) {
            console.error("Erro ao carregar dados:", textStatus, error);
        });
    }

    function preencherClientes(competencia, totalReal, valorReal, mediaReal, totalBloqueado, valorBloqueado, mediaBloqueado, totalBloqueadoAtualmente,
                              valorBloqueadoAtualmente, mediaBloqueadoAtualmente, totalGeral, valorGeral, mediaGeral, totalParalisado, valorParalisado, mediaParalisado) {
        $('#clientes_ativos_real').text('Total ' + totalReal);
        $('#valor_clientes_ativos_real').text(valorReal);
        $('#media_clientes_ativos_real').text('Média ' + mediaReal);
        $('#compentencia_cliente').text(competencia);

        $('#clientes_ativos_bloqueados').text('Total ' + totalBloqueado);
        $('#valor_clientes_ativos_bloqueados').text(valorBloqueado);
        $('#media_clientes_ativos_bloqueados').text('Média ' + mediaBloqueado);
        $('#compentencia_cliente_bloqueados').text(competencia);

        $('#clientes_ativos_bloqueados_atualmente').text('Total ' + totalBloqueadoAtualmente);
        $('#valor_clientes_ativos_bloqueados_atualmente').text(valorBloqueadoAtualmente);
        $('#media_clientes_ativos_bloqueados_atualmente').text('Média ' + mediaBloqueadoAtualmente);
        $('#compentencia_cliente_bloqueados_atualmente').text(competencia);

        $('#clientes_ativos_paralisados').text('Total ' + totalParalisado);
        $('#valor_clientes_ativos_paralisados').text(valorParalisado);
        $('#media_clientes_ativos_paralisados').text('Média ' + mediaParalisado);
        $('#compentencia_cliente_paralisados').text(competencia);

        $('#clientes_ativos_total').text('Total ' + totalGeral);
        $('#valor_clientes_ativos_total').text(valorGeral);
        $('#media_clientes_ativos_total').text('Média ' + mediaGeral);
        $('#compentencia_cliente_total').text(competencia);
        $('#competencia_ativos_bloqueados').text(competencia);

    }

    function drawChartAtivosBloqueados(ativos, bloqueados, paralisados) {
        var dataArray = [
            ['Situação', 'Quantidade'],
        ];
        dataArray.push(['Ativos', parseInt(ativos)]);
        dataArray.push(['Bloqueados', parseInt(bloqueados)]);
        dataArray.push(['Paralisados', parseInt(paralisados)]);
        var options = {
            'chartArea': {'width': '100%', 'height': '80%'},
            pieStartAngle: 50,
            legend: {position: 'bottom'},
            is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('ativos_bloqueados'));
        var data = google.visualization.arrayToDataTable(dataArray);

        chart.draw(data, options);
    }

    function drawChartAtivosBloqueadosSistema() {
      $.getJSON("/dashboards/get_cliente_12_meses_sistema?empresa=" + $('#empresas_financeiro_id').val() +
            "&estado=" + $('#estado_financeiro_id').val() +
            "&tipo='NORMAL','EM_MANUTENCAO', 'BLOQUEADO'" +
            "&data=" + $('#compentencia_cliente').text(), function(data) {
            
        var dataArray = [
            ['Sistema', 'Quantidade'],
        ];
        dataArray.push(['Manager', parseInt(data["manager"])]);
        dataArray.push(['Light', parseInt(data["light"])]);
        dataArray.push(['Emissor', parseInt(data["emissor"])]);
        //dataArray.push(['Fiscal', parseInt(data["fiscal"])]);
        dataArray.push(['Gourmet', parseInt(data["gourmet"])]);
        dataArray.push(['Pró vendas', parseInt(data["pro"])]);
        dataArray.push(['Athus', parseInt(data["athus"])]); 
        dataArray.push(['Trade', parseInt(data["trade"])]);
        dataArray.push(['Emissor WEB', parseInt(data["emissor_web"])]);
        dataArray.push(['Sem sistema', parseInt(data["sem_sistema"])]); 

        var options = {
            'chartArea': {'width': '100%', 'height': '80%'},
            pieStartAngle: 50,
            legend: {position: 'bottom'},
            is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('ativos_bloqueados'));
        var data = google.visualization.arrayToDataTable(dataArray);

        chart.draw(data, options);
      });
    }

    function drawTabelaAtivosBloqueadosSistema() {
      $.getJSON("/dashboards/get_cliente_12_meses_sistema?empresa=" + $('#empresas_financeiro_id').val() +
            "&estado=" + $('#estado_financeiro_id').val() +
            "&tipo='NORMAL','EM_MANUTENCAO', 'BLOQUEADO'" +
            "&data=" + $('#compentencia_cliente').text(), function(data) {
          console.log(data);
        var datatable = new google.visualization.DataTable();
            datatable.addColumn('string', 'Sistema');
            datatable.addColumn('number', 'Quantidade'); 
        
        datatable.addRow(['Manager', parseInt(data["manager"])]);
        datatable.addRow(['Light', parseInt(data["light"])]);
        datatable.addRow(['Emissor', parseInt(data["emissor"])]);
        //datatable.addRow(['Fiscal', parseInt(data["fiscal"])]);
        datatable.addRow(['Gourmet', parseInt(data["gourmet"])]);
        datatable.addRow(['Trade', parseInt(data["trade"])]);
        datatable.addRow(['Pró vendas', parseInt(data["pro"])]);
        datatable.addRow(['Athus', parseInt(data["athus"])]); 
        datatable.addRow(['Emissor WEB', parseInt(data["emissor_web"])]);
        //datatable.addRow(['Sem sistema', parseInt(data["sem_sistema"])]); 

        datatable.sort({column: 1, desc: true});        

        var table = new google.visualization.Table(document.getElementById('ativos_bloqueados'));          
          
        table.draw(datatable, {allowHtml: true, width: '100%', height: '100%',});
      });
    }
    
    function carregarInfoClientesAtivos() {
        $('#bloco_clientes_bloqueados').hide();
        $('#bloco_clientes_bloqueados_atualmente').hide();
        if($('#bloco_clientes_ativos').is(':visible')){
            $('#bloco_clientes_ativos').hide();
        }else{
            $('body').lmask('show');
            $.getJSON("/dashboards/table_clientes_ativos_bloqueados?empresa=" + $('#empresas_financeiro_id').val() +
                "&estado=" + $('#estado_financeiro_id').val() +
                "&tipo='NORMAL','EM_MANUTENCAO'" +
                "&data=" + $('#compentencia_cliente').text(), function(data) {

                $('#bloco_clientes_ativos').show();
                var table = $('.table-clientes-ativos').DataTable();
                table.clear().draw();
                $.each(data,function (i,val){
                    table.row.add( [
                        moment(val['datavencimento']).format("DD/MM/YYYY"),
                        val['dias_sem_uso'],
                        val['dias_cliente'],
                        val['razaosocial'],
                        val['cidade'],
                        val['sistema'],
                        mascaraValor(val['valor'])
                    ] ).draw( false );
                });

                $('body').lmask('hide');
            });
        }
    }

    function carregarInfoClientesBloqueados(tipo) {
        $('#bloco_clientes_ativos').hide();
        $('#bloco_clientes_bloqueados_atualmente').hide();
        if($('#bloco_clientes_bloqueados').is(':visible')){
            $('#bloco_clientes_bloqueados').hide();
        }else{
            $('body').lmask('show');
            $.getJSON("/dashboards/table_clientes_ativos_bloqueados?empresa=" + $('#empresas_financeiro_id').val() +
                "&estado=" + $('#estado_financeiro_id').val() +
                "&tipo='" + tipo + "'" +
                "&data=" + $('#compentencia_cliente').text(), function(data) {

                $('#bloco_clientes_bloqueados').show();
                var table = $('.table-clientes-bloqueados').DataTable();
                table.clear().draw();
                $.each(data,function (i,val){
                    table.row.add( [
                        moment(val['databloqueio']).format("DD/MM/YYYY"),
                        val['dias_bloq'],
                        val['dias_sem_uso'],
                        val['dias_cliente'],
                        val['razaosocial'],
                        val['cidade'],
                        val['sistema'],
                        mascaraValor(val['valor']),
                        val['hist_ligacoes']
                    ] ).draw( false );
                });

                $('body').lmask('hide');
            });
        }
    }
  
    function carregarInfoClientesBloqueadosAtualmente() {
        $('#bloco_clientes_ativos').hide();
        $('#bloco_clientes_bloqueados').hide();
        if($('#bloco_clientes_bloqueados_atualmente').is(':visible')){
            $('#bloco_clientes_bloqueados_atualmente').hide();
        }else{
            $('body').lmask('show');
            $.getJSON("/dashboards/table_clientes_bloqueados_atualmente?empresa=" + $('#empresas_financeiro_id').val() +
                "&estado=" + $('#estado_financeiro_id').val() +
                "&data=" + $('#compentencia_cliente').text(), function(data) {
                $('#bloco_clientes_bloqueados_atualmente').show();
                var table = $('.table-clientes-bloqueados-atualmente').DataTable();
                table.clear().draw();
                $.each(data,function (i,val){
                    table.row.add( [
                        moment(val['databloqueio']).format("DD/MM/YYYY"),
                        val['dias_bloq'],
                        val['dias_sem_uso'],
                        val['dias_cliente'],
                        val['razaosocial'],
                        val['cidade'],
                        val['sistema'],
                        mascaraValor(val['valor']),
                        val['hist_ligacoes']
                    ] ).draw( false );
                });

                $('body').lmask('hide');
            });
        }
    }

    function drawTicketMedioClientesAtivos() {
      $.getJSON("/dashboards/get_cliente_12_meses_sistema?empresa=" + $('#empresas_financeiro_id').val() +
            "&estado=" + $('#estado_financeiro_id').val() +
            "&tipo='NORMAL','EM_MANUTENCAO', 'BLOQUEADO'" +
            "&data=" + $('#compentencia_cliente').text(), function(data) {            
        
        var datatable = new google.visualization.DataTable();
            datatable.addColumn('string', 'Sistema');
            datatable.addColumn('number', 'Ticket médio');
            
          if (data["media_man"] > 0) 
            datatable.addRow(['Manager', parseFloat(data["media_man"])]);
          else
            {datatable.addRow(['Manager', parseFloat(0)]);}
          
          if (data["media_lig"] > 0) 
            datatable.addRow(['Light', parseFloat(data["media_lig"])]);
          else
            datatable.addRow(['Light', parseFloat(0)]);

          if (data["media_emi"] > 0)
            datatable.addRow(['Emissor', parseFloat(data["media_emi"])]);
          else
            datatable.addRow(['Emissor', parseFloat(0)]);
          
          // if (data["media_f"] > 0)
          //   datatable.addRow(['Fiscal', parseFloat(data["media_f"])]);
          // else
          //   datatable.addRow(['Fiscal', parseFloat(0)]);

          if (data["media_g"])
            datatable.addRow(['Gourmet', parseFloat(data["media_g"])]);
          else 
            datatable.addRow(['Gourmet', parseFloat(0)]);

          if (data["media_trade"])
            datatable.addRow(['Trade', parseFloat(data["media_trade"])]);
          else 
            datatable.addRow(['Trade', parseFloat(0)]);

          if (data["media_pro"])
            datatable.addRow(['Pró vendas', parseFloat(data["media_pro"])]);
          else
            datatable.addRow(['Pró vendas', parseFloat(0)]);

          if (data["media_athus"])
            datatable.addRow(['Athus', parseFloat(data["media_athus"])]);
          else
            datatable.addRow(['Athus', parseFloat(0)]);

          if (data["media_emissor_web"])
            datatable.addRow(['Emissor WEB', parseFloat(data["media_emissor_web"])]);
          else
            datatable.addRow(['Emissor WEB', parseFloat(0)]);
            
          datatable.sort({column: 1, desc: true});

          var table = new google.visualization.Table(document.getElementById('ativos_bloqueados'));
          var formatter = new google.visualization.NumberFormat(
              {prefix: 'R$ ', negativeColor: 'red', negativeParens: true});
          formatter.format(datatable, 1); // Apply formatter to second column
          
          table.draw(datatable, {allowHtml: true, width: '100%', height: '100%',});
      });
    }

    function drawClientesAtivosPorUF() {
      $.getJSON("/dashboards/get_cliente_UF?empresa=" + $('#empresas_financeiro_id').val() +
            "&tipo='NORMAL','EM_MANUTENCAO', 'BLOQUEADO'" +
            "&data=" + $('#compentencia_cliente').text() + "&flag=1", function(data) {         
        
        var datatable = new google.visualization.DataTable();
            datatable.addColumn('string', 'Estado');
            datatable.addColumn('number', 'Quantidade');

        for (var i = 0; i < data.length; i++) {
          datatable.addRow([data[i].estado, data[i].qtd]);
        }         
            
        datatable.sort({column: 1, desc: true});
        for (var i=0; i< data.length; i++){
          datatable.setRowProperty(i, 'className', 'h30');
        }
        //datatable.setRowProperty(data.length-1, 'className', 'bold');

        var table = new google.visualization.Table(document.getElementById('ativos_bloqueados'));          
          
        table.draw(datatable, {allowHtml: true, width: '100%', height: '100%',});
      });
    }

    // Nova função para calcular e exibir indicadores de crescimento apenas uma vez
    function calcularEExibirIndicadoresCrescimento() {
        var dados = window.dadosUltimos12Meses;
        if (!dados || dados.length < 4) {
            console.log("Dados insuficientes para calcular crescimento");
            $('#quarter-growth-clients').html("Dados insuficientes");
            $('#quarter-growth-value').html("Dados insuficientes");
            $('#year-growth-clients').html("Dados indisponíveis");
            $('#year-growth-value').html("Dados indisponíveis");
            return;
        }
        
        console.log("Calculando indicadores de crescimento");
        
        // Usando os dados do último mês disponível
        var mesAtual = dados[dados.length - 1];
        
        // Dados para o cálculo trimestral (3 meses atrás)
        var mesTrimestre = dados[dados.length - 4];
        
        // Dados para comparação anual
        var partesMesAtual = mesAtual.final.split('/');
        if (partesMesAtual.length === 2) {
            var nomeMesAtual = partesMesAtual[0];
            var anoAtual = partesMesAtual[1];
            var anoAnterior = (parseInt(anoAtual) - 1).toString();
            
            // Organizar dados por mês e ano para comparação anual
            var dadosPorData = {};
            for (var i = 0; i < dados.length; i++) {
                var mes = dados[i];
                var partes = mes.final.split('/');
                if (partes.length === 2) {
                    var nomeMes = partes[0];
                    var ano = partes[1];
                    
                    if (!dadosPorData[ano]) {
                        dadosPorData[ano] = {};
                    }
                    
                    dadosPorData[ano][nomeMes] = mes;
                }
            }
            
            // Crescimento em relação ao trimestre (3 meses atrás)
            var crescimentoTrimestral = calcularCrescimento(mesAtual, mesTrimestre);
            exibirCrescimento('quarter', crescimentoTrimestral);
            
            // Crescimento em relação ao mesmo mês do ano anterior
            if (dadosPorData[anoAnterior] && dadosPorData[anoAnterior][nomeMesAtual]) {
                var mesAnoAnterior = dadosPorData[anoAnterior][nomeMesAtual];
                var crescimentoAnual = calcularCrescimento(mesAtual, mesAnoAnterior);
                exibirCrescimento('year', crescimentoAnual);
            } else {
                console.log("Dados do mesmo mês no ano anterior não disponíveis para", nomeMesAtual, anoAnterior);
                $('#year-growth-clients').html("Dados indisponíveis");
                $('#year-growth-value').html("Dados indisponíveis");
            }
        }
    }

    // Função auxiliar para calcular o crescimento entre dois períodos
    function calcularCrescimento(mesAtual, mesAnterior) {
      var qtdAtual = parseInt(mesAtual.totalqtd) || 0;
      var qtdAnterior = parseInt(mesAnterior.totalqtd) || 1; // Evitar divisão por zero
      var valorAtual = parseFloat(mesAtual.totalvalor) || 0;
      var valorAnterior = parseFloat(mesAnterior.totalvalor) || 1; // Evitar divisão por zero
      
      var crescimentoQtd = ((qtdAtual - qtdAnterior) / qtdAnterior) * 100;
      var crescimentoValor = ((valorAtual - valorAnterior) / valorAnterior) * 100;
      
      return {
        periodo: {
          atual: mesAtual.final,
          anterior: mesAnterior.final
        },
        clientes: {
          atual: qtdAtual,
          anterior: qtdAnterior,
          variacao: crescimentoQtd
        },
        valor: {
          atual: valorAtual,
          anterior: valorAnterior,
          variacao: crescimentoValor
        }
      };
    }

    // Função auxiliar para formatar os valores e exibi-los
    function exibirCrescimento(tipo, dados) {
      var elementClientes = $('#' + tipo + '-growth-clients');
      var elementValor = $('#' + tipo + '-growth-value');
      
      // Formatação para clientes
      var classClientes = dados.clientes.variacao >= 0 ? 'value-increase' : 'value-decrease';
      var simboloClientes = dados.clientes.variacao >= 0 ? '▲' : '▼';
      var percentualClientes = Math.abs(dados.clientes.variacao).toFixed(1) + '%';
      
      // Calcular a diferença absoluta de clientes
      var diferencaAbsolutaClientes = dados.clientes.atual - dados.clientes.anterior;
      
      // Criar badge com cores mais sutis
      var badgeClientes = '<span class="stat-badge ' + (dados.clientes.variacao >= 0 ? 'badge-increase-subtle' : 'badge-decrease-subtle') + '">' + 
                          simboloClientes + ' ' + percentualClientes + 
                          ' (' + (diferencaAbsolutaClientes >= 0 ? '+' : '') + diferencaAbsolutaClientes + ')</span>';
      
      var textoClientes = dados.clientes.anterior + ' → ' + dados.clientes.atual + ' ' + badgeClientes;
      elementClientes.html(textoClientes);
      elementClientes.removeClass('value-increase value-decrease').addClass(classClientes);
      
      // Formatação para valor
      var classValor = dados.valor.variacao >= 0 ? 'value-increase' : 'value-decrease';
      var simboloValor = dados.valor.variacao >= 0 ? '▲' : '▼';
      var percentualValor = Math.abs(dados.valor.variacao).toFixed(1) + '%';
      
      // Calcular a diferença absoluta de valor
      var diferencaAbsolutaValor = dados.valor.atual - dados.valor.anterior;
      var diferencaFormatada = Math.abs(diferencaAbsolutaValor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      
      // Criar badge com cores mais sutis
      var badgeValor = '<span class="stat-badge ' + (dados.valor.variacao >= 0 ? 'badge-increase-subtle' : 'badge-decrease-subtle') + '">' + 
                       simboloValor + ' ' + percentualValor + 
                       ' (' + (diferencaAbsolutaValor >= 0 ? '+' : '-') + 'R$ ' + diferencaFormatada + ')</span>';
      
      var valorAnteriorFormatado = 'R$ ' + dados.valor.anterior.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      var valorAtualFormatado = 'R$ ' + dados.valor.atual.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      
      var textoValor = valorAnteriorFormatado + ' → ' + valorAtualFormatado + ' ' + badgeValor;
      elementValor.html(textoValor);
      elementValor.removeClass('value-increase value-decrease').addClass(classValor);
    }

</script>